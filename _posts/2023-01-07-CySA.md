---
title: CySA+ Preparation Content
author: Adri√†
date: 2023-01-07 14:10:00 +0800
img_path: /img/posts/2023-01-07-CySA/
categories: [CySA, Certifications, BlueTeam]
tags: 
render_with_liquid: false
---

In this post I want to group all the content related with the CySA certification that I considere important and worth to keep in this site. I want to clarify that some important content may not be added because I feel that I already know and it is not worth to spend that extra time. 


# Threat Intelligence Sharing

## Security vs Threat Intelligence

**Security Intelligence** is the process through which data generated in the ongoing use of systems is collected, processed, analyzed and disseminated in order to provide a security status of those systems. 

**Threat Intelligence** is the process of collecting, investigating, analyzingand disseminating information about emerging threats to obtain an external threat landscape.


## Intelligence Cycle

Security intelligence is a process. You can see diferents schemas in the internet and they may be a bit different (some of them group steps into a unique step), but the overall idea is the same. 

![Intelligence Cycle](intell-cycle.png)

1. **Requirements, Planning and Direction:** In this phase the goals for the intelligence gathering effort/cycle is set. 
2. **Collection and Processing:** The **collection** of the data can be done by software tools and SIEMs. Afterwards, this data is **processed** using **Data Enrichment** processes with the goal to keep relevant data. 
3. **Analysis:** The **analysis** of the processed data is performed against the use cases decided from the **Requirements, Planning and Directon** phase. This step can make use of auto model analysis, using machine learning and artificial intelligence.  
4. **Dissemination:** In ths phase the results obtained by the analysis is published to consumers so other teams can take action. Thei can be classified using the type of intelligence they refere:
	- Strategic Intelligence: related with broad things and objectives. They are usually reports to executives, power point slides, etc.
	- Operational Intelligence: Adresses the day to day priorities of the specialists. 
	- Tactical Intelligence: They refere to real time decisions, like alerts detected by the SOC. 
5. **Review/Feedback:** This phase aims to clarify the requirements and improve the the Collection, analysis and dissemination phases for the next cycle by reviewing the current inputs and outputs. Usually the feedback phase takes into account: 
	- Lessons learned
	- Measurable success
	- Evolving threat issues

## Intelligence Sources

The **Collection and Processing** step of the Intelligence Cycle, we have to analyze the sources that are used to obtain the data. We should considere this properties of the sources and data: 

- Timeliness: Property of a source that ensures that it is up-to-date.
- Relevancy: Property of a source that ensures that it matches the use cases intended for it and that the data that the source provides is relevant. 
- Accuracy: Property of a soruce that ensures that the results are accurate and effective. 
- Confidence Levels: Property of a source that ensures the produced statements are reliable. 

The places where we obtain the data can also be classified: 

- Proprietary: Comercial services offering acces to updates and research data.
- Close-source: Data obtained from the own provider's research. 
- Open-Source:  Public available data from public databases. 
	- US-CERT
	- UK NCSC
	- AT&T Security
	- **MISP (Malware Information Sharing Point)**
	- Virus Total
	- Spanhaus
	- SANS ISC Suspicious DOmains

**OSINT** ara the methods to obtain information through public records, websites, and social media. 

## ISACS: Intelligence Sharing and Analysis Centers

The ISAC is a non-profit group set to share sector-specific threat intelligence and security best practices (CISP is the same but in the UK). There are diferent types of ISACS, classified using the sector: 
	- Critical Infrastructure
	- Goverment
	- Healthcare
	- Financial
	- Aviation
## Threat Intelligence Sharing (within the organitzation)

In the **Dissemination** phase, is important to share the information with the corresponding teams to act according to the situation (make use of the data).

- Risk Management: Identify, evaluate and prioritizes threats and vulnerabilities to reduce the impact. 
- Incident Response: Organized approach to address security-breach/cyber-attacks.
- Vulnerability Management: Identify, classify and prioritize software vulnerabilities. 
- Detection and Monitoring: The practice of observing to identify anomalous patterns to analyze them further. 
 
# Classifying Threats

## Types of Malware
- **Commodity Malware:** This type of malware is available to purchase or it is free. They exploit a known vulnerability. Is used by a wide range of threat actors. 
- **Zero-day:** Malware that exploits a zero-day vulnerability, which means that is a vulnerability that has just been discovered. 
- **APT - Advance Persistent Threats:**They are usually performed by Organized Crime and once they obtain access, they mantain it in order to obtain information. The information is obtained by the malware and sent to the *Command and Control (C2)*, a infrastructure of hosts and services with which the attackers direct, distribute and control the malware over bots/zombies (botnets). 

## Threat Research

Threats used to be identifyed by a signature (part of the threat that is re that allowed them to be recognizable). However, obfuscating techniques have become better and searching for the signature is no longer the best option. Some different ways to identify threats can be: 
- **Reputational Threat Research:** This consists of a blacklists of known threat sourcesn like signatures, IP addresses ranges and DNS domains. If something is dettected comming from thoose sources, is classified as a threat. 
- **Indicator of Compromise (IOC):** Thoose are residual signs that an asset or network have been compromised (or is beeing attacked). Modified files, excessive bandwith, unknown port ussage and suspicious emails can be IOC. If the attack is still going on, instead of saying it is a IOC, we will say it is a Indicator of Attack (IOA). 
- **Behavioral Thread Research:** This detection technique is based on Tactics, Techniques and Procedures used by the threats. They correlate the IOC with attack patterns. Some examples can be: 
	- DDoS
	- Viruses and Worms
	- Network Reconnaissance
	- APT
	- Data Exfiltration

The C2 that the APT's use may do **Port Hopping** technique in order to use different ports and make them more difficult to detect. Another technique that they may use is **Fast Flux DNS**, which consists on changing the IP address associated with a domain frequently.  

## Attack Frameworks

A **Kill Chain** is a framework that was first introduced by Lockheed Martin (military US company) and it describes the stages bw which a threat actor progresses in a network intrusion attack. 

1. Reconnaissance: The attacker determines the methods that will be used to continue with the attack by gathering information about the victim. It can be used Passive or Active information gathering. 
2. Weaponization: This is the step were the malware/exploit is developed considering the detected vulnerabilities. 
3. Delivery: In this step the method that will be used to introduce the attack will be identified. 
4. Explotation: This step occurs when the exploit/malware is successfully introduced. 
5. Installation: When the malware gets executed, this step allows to obtain a remotr access tool to the victim and achieve persistance. 
6. Comand and Control (C2): Establish a outbound channel to a reomote server (botnet) to progress withthe attack. 
7. Actions on Objectives: Attackers make use of the access achieved to collect what they want. 

The **MITRE ATT&CK Framework** is a knowledge base that consist of a matrix where different tactics and techniques used by the attacers are described. You can check it here <https://attack.mitre.org/matrices/enterprise/>. 

Last but not least, we have the **Diamond model of Intrusion Analysis**. This framework analyzes the security incidents by exploring the relationship between four features: adversary, capability, infrastructure and victim. This is a complex model, that can also help to create Activity Threads and Activity Attack Graphs. Fore a more detailed information, I suggest reading this post: <https://www.socinvestigation.com/threat-intelligence-diamond-model-of-intrusion-analysis/>. 

## Indicator Management

It is important to use a normalized way when sharing information about threats. 

**STIX (Structured Thread Information eXpression)** is a standar terminology for IOCs and a way to indicate relationships between them. It is expressed in JSON. It has objects that contain multiple attributes with their corresponding value: 
	- Observed Data
	- Indicator
	- Attack Patterns
	- Campaign agains threat actor
	- Courses of Action (mitigation techniques used to reduce the attack)

**TAXII (Trusted Automated eXchange of Indicator Information)** is a protocol for supplying codified information to aoutomate incident detectiond and analysis. The analysis tools provide updates of the threats using this protocol. 
![TAXII protocol](taxii.jpg)

**OpenIOC** is a framework that uses XML files for supplying codified information to automate indicent detection. 

**MISP (Malware Information SHaring Protocol)** provides a server platform that allows cyber intelligence sharing. It supports OpenIOC definitions and can receive and send information using STIX over the TAXII protocol. 

#Threat Hunting

Threat hunting is a technique designed to detect presence of threats that have not been discovered by normal security monitoring. Is also less disruptive than a penetration test. 
## Threat Modeling 

Threat modeling is a structured approach to identifying potential threats and vulnerabilities in a system, network, or application. The goal of threat modeling is to understand the potential attack vectors and to identify and prioritize the risks associated with them. This process typically involves:
- Identify the attack vectors 
- The impact of the attack in terms of confidentiality, integrity and availability of the data
- Identify the likelihood of the attack to occur
- What mitigations can be implemented

The information gathered during threat modeling can then be used to inform security design and implementation decisions.

The **Adversary Capability** can be classified to determine de resources and expertise availabe by the threat actor: Aquired and augmented, Developed, Advanced and Integrated

The **Attack Surface** can be classified to determine the points where a network or app receives external connections that can be exploited: Holistic network, Websites and cloud-services and Custom software applications. 

The **Attack Vector** is the methodology used by the attackers to gain acces to the network or exploit a gain unauthorized acces: Cyber, Human and Physical. 

The **Likelihood** is the chance of a threat being exploited. 

The **Impact** is the cost of a security incident. Usually expressed in cost (money). 

## OSINT (Open-Source Intelligence)

All the public information and tools that can be used by the attacker to obtain specific data about a victim is classified as OSINT. It can allow the attacker to develop a stretegy for compromising the victim. [_Here_](https://osintframework.com/) you can find all the OSINT framework with different tools that can be used and public information. 

Some of the most used and know ones are: 

- **Google Hacking**: Use Google search advance operators ("", NOT, AND/OR, and keywors to determine the scope of the search, such as _site, flietype, related,..._) to locate desired information. You can visit the [Google Hacking Database](https://www.exploit-db.com/google-hacking-database) to obtain usefull queries. 

- **Shodan**: shodan.io is a search engine optimized for identifying vulnerable Internet-attached devices. It can allow you to search, for example, open ssh ports facing the internet without having to do an active scan.

- **Profiling Techniques** such as Email Harvesting can be used to try to guess valid and existing email addresses for a specific domain. 

- **Harvesting Techniques** such as _whois_ command, DNS Zone Transfer (method that asks for a replicated DNS database across a set of DNS servers that will reply if they are missconfigured) and DNS/Web Harvesting are other OSINT tools used to gain information about subdomains, source code, hosting providers, comments in the website code, etc. 

> If you want to know more about OSINT and passive information gathering, you can read this other post [Passive Information Gathering](https://adriapt.github.io/posts/OSCP-6/) that I wrote when I was studying for the OSCP certification.
{: .prompt-tip }    

# Network Forensics

## Tools 

In order to analyze network traffic, it must be captured and decoded. 

- **Switched Port Analyzer (SPAN):** This is a feature that can be activated in a switch. This feature, also known as port mirroring, makes a copy of the traffic seen on a single port or multiple ports and sends the copy to another port (usually a monitoring port which will process the packets).

- **Packet Sniffer:** This can be a fisical debice connected to a network or a software program that uses records data frames as they pass over the network. Deppending on the placement of the sniffer inside the network, it will be able to sniff more or less data. 
	- Wireshark and tcpdump are software programms that can be used to sniff traffic. 

## Flow Analysis  

There are different ways to analize the flow that you capture: 

- **Full Packet Capture (FPC):** The entire packet is captured (header+payload).
- **Flow Collector:** It just records mettadata and statistics about the traffic blow, but not the traffic itself. 
	- **NetFlow:** This is a standard developed by CISCO and is used to report the nerwork flow into a structured database. It includes: 
		1. Network protocol interface
		2. Version and type of IP 
		3. Source and destination IP
		4. Source and destination port
		5. IPs ToS (Type of Service)
- **Zeek:** This is a hybrid tool that monitors the network in a passive form and only logs relevant data. The events are stored in JSON format. 
- **Multi Router Traffic Grapher (MRTG):** This tool creates graphs that show traffic flows through the network interfaces of routers and switches by using SNMP (Simple Network Management Protocol). 

## IP and DNS Analysis

There are **Known-bad IP/DNS addresses**, which are range of addresses taht appears in blackists and can help to detect if the traffic is malicious.  

Recent malware uses **Domain Generation Algorithms (DGA)** to evade blackists. The purpose of a DGA is to make it harder for security researchers and network defenders to identify and block the C2 servers used by the malware.

The algorithm usually uses a seed value and an algorithm to generate a large number of domain names. The seed value can be based on a specific date, time or some other value that is known to both the malware and the C2 server. The algorithm then generates a large number of domain names by applying the seed value to the algorithm.

Some of the common techniques used by DGA are:

    Using a predefined set of words or characters and applying mathematical operations to them.
    Using encryption functions to generate domain names.
    Using a combination of words or characters that are unlikely to be registered by legitimate domain owners.

Once the domain names are generated, the malware will try to connect to each one of them in a specific order, until it finds the C2 server. The C2 server will then be used to download additional malware, exfiltrate data, or receive commands.

![DGA](dga.jpg)

A **Fast Flux Network (FFN)** is another method used by the malware to avoid being detected. FFN is a type of botnet that uses a technique to hide the true location of a command-and-control (C2) server by constantly changing the IP address associated with a specific domain name using a technique known as "fast flux" where the IP address associated with the domain name changes frequently. The malware infects a large number of machines and turns them into "proxies" for the C2 server. The main goal of a FFN is to evade detection by making it difficult to identify and block the C2 server used by the malware. 

## URL Analysis 

Another way to detect a possible attack is to perform a URL Analysis. 

Percent-encoding, also known as **URL encoding**, is a technique used to encode special characters, such as spaces, slashes, and ampersands, that are not allowed in URLs so that they can be transmitted safely. It replaces these characters with a percentage sign followed by the ASCII code of the character in hexadecimal form. This technique is also important for preventing cross-site scripting (XSS) attacks by encoding special characters that could be used in an XSS attack so that they are not executed by the browser.

Here you can find a list with the more usefull ones: 

| Symbol Representation  | Encoding |
|-----------------------|----------|
| " " (Space)           | %20      |
| "&" (Ampersand)       | %26      |
| "+" (Plus)            | %2B      |
| "," (Comma)           | %2C      |
| "/" (Forward slash)  | %2F      |
| ":" (Colon)           | %3A      |
| ";" (Semi-colon)      | %3B      |
| "=" (Equals)          | %3D      |
| "?" (Question mark)   | %3F      |
| "@" (At sign)         | %40      |
| "$" (Dollar sign)     | %24      |
| "#" (Pound sign)      | %23      |
| "<" (Less than)       | %3C      |
| ">" (Greater than)    | %3E      |
| "'" (Single quote)    | %27      |
| """ (Double quote)    | %22      |

# Application Monitoring 

## Firewalls

Firewall Logs keep a lot of usefull data that can be used to detect suspicious behaviour. They keep the connections that have been alowed or denyed, the protocols used, the bandwith usage, NAT/PAT translation, etc. The rules that the firewall will follow for deciding the permitted and denied connections will be defined in the **Access Control List (ACL)**

The format of the logs will be vendor specific: 

- **iptables** 
	This is a Linux based firewall that uses the syslog file format to store the data. The logs have a code that can help to identify the severitoy of log.
	
| Code  | Severity    | Description                                                 |
|-------|-------------|-------------------------------------------------------------|
| 0     | Emergency   | The system is unusable.                                      |
| 1     | Alert       | Action must be taken immediately.                            |
| 2     | Critical    | Critical conditions.                                         |
| 3     | Error       | Error conditions.                                            |
| 4     | Warning     | Warning conditions.                                         |
| 5     | Notice      | Normal but significant condition.                            |
| 6     | Informational| Informational messages.                                      |
| 7     | Debug       | Debug-level messages.                                        |

- **Windows Firewall**
	It uses W3C Extended Log File Format. This is  a format used by web servers to record information about requests made to the server, while syslog is a standard used to send log messages from network devices to a centralized log server.


When a Firewall is under-resourced and logs can't be collected fast enough, an attacker could exploit this by sending a lot of thata and overwhelming the firewall, hence the traffic can't be collected properly nor detect unauthorized access. This is known as a **Blinding Attack**

## Firewall Configurations

It is important to study where the Firewall will be placed in the network. However, this will be diffent for each use case. 

- **Demilitarized Zone DMZ**: If your network has servers that exposes services (like web pages) to the Internet, they are usaly in a independent subnetwork, isolated from the internal network of the company. Since thoose services are exposed to the Internet, are more vulnerable and is important to add a separation between them and your other servers/workstations. This DMZ zone usually has a Firewall facing the internet, allowing trafic related with the services exposedand  another one between the DMZ and the internal network, more restrictive.
 
![DMZ](DMZ.png)

It is also important that the ACLs are processed from top-to-bottom, this means that the most specific rules have to be in the top and the generall ones at the end. Some principles for a good ACL configuration are: 
1. Block incoming requests from private, loopback and multicast IP address ranges. 
2. Block protocols that should only be used locally and not received from the internet, like: ICMP, DHCP, OSPF, SMB. 
3. Authorize just known hosts and ports to use IPv6

A firewall can **DROP** a packet or **REJECT** it. When the deny rule **REJECTS** the packet, it explicitly sends a response saying that the traffic has been rejected. However **DROPPING** it will just ignore the packet and the sender won't receive any answer, which will difficult the work (for example, mapping the ports and network) if it is a malicious adversary.  Dropping can be used to create a **Black Hole** and avoid DoS and DDoS attacks by sending the traffic to the null0 interface and not sending a response. 

You can also configure your Firewall to send to the **Black Hole** all unused IP addreses within your network, because they should not be used, and if usage is dettected it is unauthorized. 

A **Sinkhole** is like a **Black Hole** but instead of sending the traffic to the null0 interface, it is redirected to another subnet for further investigation. 


Is also important to observe the eggress traffic. A host could have been infected by malware and communicating with the internet (Comanda and Control servers). Best practice for configuring egress traffic are: 
1. Allow whitelisted apps, ports and destination addresses
2. Restrict DNS lookups to trusted DNS services
3. Block access to known bad IP address ranges (blacklist)
4. Block all internet access from host that don't use internet


## Proxy Logs

A proxy is a server that acts as an intermediary between a client and another server (e.g., a web server). It can be a Forward or Reverse proxy, and they can also be transparent and Nontransparent. 

- **Forward Proxy**: A forward proxy is a proxy that is used by a client to access resources on a remote server. The client sends a request to the forward proxy, which then forwards the request to the remote server, and returns the server's response to the client. Imagine a company that makes all its workstations to go through a proxy before going to the internet. This situation will imply a forward proxy. 

- **Reverse Proxy**: A reverse proxy is a proxy that is used by a server to handle client requests. It is the reverse situation from the forward proxy. Instead of forwarding packets from the clients to the servers, it collects packets received through the internet and redirects to different servers according to the situation. 

A **nontransparent** proxy is the proxy that has to be configured in the client browser, specifying the proxy IP and port (for example Burpsuite). A **transparent** proxy is a type of proxy server that intercepts and forwards requests and responses to the intended destination without the client being aware of it. It is used for caching frequently requested content, blocking certain types of content, translating IP addresses for clients on a private network to access the internet, and requiring authentication for access control. The client does not need to be configured to use it as it operates in a transparent mode.

Proxy Logs can be analyzed searching for indicators of attack.
![Proxy](proxy.png)

## Web Application Firewall Logs (WAF)

A Web Application Firewall (WAF) is a security tool that protects web applications from malicious attacks by analyzing incoming traffic and comparing it to predefined rules or patterns. If the traffic matches a known attack, such as SQL injection, XML injection, XSS, DoS, etc. the WAF takes action to block the request. It can be implemented as software or hardware, and can be a standalone solution or part of other security products.

Usually the WAFs store their logs in JSON format and they contain: 
	- Time of event
	- Severity of event
	- URL parameters
	- HTTP method used
	- Context for the rule

## Intrusion Detection System (IDS)

An IDS is a type of security software or hardware that is designed to detect and alert on unauthorized access or malicious activity on a computer network or system.

IDS systems work by continuously monitoring network traffic for suspicious patterns, anomalies, or known malicious activity. They can be set up in two different ways:

**Network-based IDS (NIDS)**: These systems monitor all the traffic that flows through a network, looking for suspicious activity. They are placed at strategic points in the network to monitor traffic from all devices connected to the network.

**Host-based IDS (HIDS)**: These systems monitor the activity on a single host or device, such as a server or a workstation. They are installed on the host itself, and monitor the system logs, process activity, and other data to detect any suspicious activity.

When an IDS detects suspicious activity, it generates an alert or alarm, which can be used to alert network administrators or trigger an automatic response, such as blocking the offending IP address or shutting down the affected service.

## Intrusion Prevention System (IPS)

An IPS is a security technology that is similar to an IDS, but with the added capability to take action to prevent unauthorized access or malicious activity on a computer network or system.
The actions that an IPS can take include:
- Blocking traffic from a specific IP address or network
- Closing a specific network port
- Quarantining a device on the network
- Logging off a user

An IPS is considered more advanced than an IDS, as it can prevent malicious activity from occurring in real-time, rather than just detecting it and raising an alert. However, it's important to note that IPS systems, like any other security device, can produce false positives and negatives, so it's crucial to have a well-configured and fine-tuned system to maximize its effectiveness.


**Snort** is an open-source, free, and widely-used Intrusion Detection and Prevention System (IDPS) tool. It can be used as both a network-based IDS (NIDS) and a host-based IDS (HIDS) depending on the configuration.

Snort uses a rule-based language to define what it should look for when scanning network traffic. Each rule is made up of several different parts, including:
- **Action**: This is the first part of the rule, and it specifies what action Snort should take when the conditions specified in the rule are met. For example, an action can be "alert", "log", "pass", "activate", "dynamic" among others.
- **Protocol**: This specifies the protocol that the rule applies to, such as TCP, UDP, or ICMP.
- **Source and destination IP addresses**: These specify the IP addresses that the rule applies to. They can be either a specific IP address or a range of IP addresses.
- **Source and destination ports**: These specify the ports that the rule applies to. They can also be either a specific port or a range of ports.
- **Direction**: This field specifies the direction of the rule, either "->" (from source to destination) or "<>" (bidirectional).
- **Options**: This field is used to specify additional conditions that Snort should look for, such as specific content in the packet, specific flags set in the packet header, or specific values in the packet payload.
- **Message**: This field is used to specify a message that will be displayed when the rule is triggered.

An example of a Snort rule:
```
alert tcp $EXTERNAL_NET any -> $HOME_NET 22 (msg:"SSH Brute Force"; flow:to_server,established; 
threshold:type limit,track by_src,count 2,seconds 1; classtype:attempted-recon; sid:10000001; rev:1;)
```
This rule will trigger an alert when it detects a TCP connection coming from the external network to the home network on port 22 (SSH) with the message "SSH Brute Force". It's also configured to track the connection by source IP and only trigger the alert when it detects 2 connections in 1 second.

## Network Access Control (NAC) Configuration 
Network access control (NAC) provides the means to authenticate users and evaluate device integrity before a network connection is permitted. 

**IEE 802.1X** is a standard for port-based Network Access Control (NAC) that provides a framework for authenticating and controlling access to a network. It is commonly used in wireless networks and wired Ethernet networks to provide a secure connection for devices.

The 802.1X protocol works by using a supplicant (the device that wants to connect to the network) and an authenticator (a network device such as a switch or wireless access point) to establish a secure connection.

The basic process for 802.1X authentication is as follows:
1. The supplicant (device) attempts to connect to the network.
2. The authenticator (switch or Access Point) receives the connection attempt and sends an EAP-Request/Identity message to the supplicant, requesting the device's credentials.
3. The supplicant sends an EAP-Response/Identity message containing the device's credentials (such as username and password) to the authenticator.
4. The authenticator forwards the credentials to an Authentication Server (using RADIUS protocol) to verify the device's identity.
5. The Authentication Server verifies the credentials and sends an EAP-Response message indicating whether the device is authorized to access the network.
6. If the device is authorized, the authenticator sends an EAP-Success message to the supplicant, allowing the device to access the network.

802.1X also supports other types of authentication methods, such as certificate-based authentication and token-based authentication, in addition to the username and password based authentication.

All the steps above use EAP messages. However, the communication between the Supplicant and the Authenticator uses EAPOL and the communication between the Authenticator and the Authenticatos Server uses RADIUS. 

In summary, **EAP (Extensible Authentication Protocol)** is a framework that defines a standard way to provide authentication and security for wireless networks, **EAPOL (EAP over LAN)** is a network protocol that is used to carry EAP messages over LANs, and **RADIUS (Remote Authentication Dial-In User Service)**  is a network protocol that is used to authenticate and authorize users attempting to connect to a network. Together, these protocols provide a flexible and secure way to authenticate and control access to a network using 802.1X.

![802.1X](802.1X.png)


